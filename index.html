<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>BOQ Manager â€” Project Cost Estimation Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="shortcut icon" href="assets/icon.png" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* ===================== THEME ===================== */
    :root {
      color-scheme: light;
      --bg: #f4f6f8;
      --txt: #111;
      --muted: #777;
      --card: #fff;
      --border: #e6e6e6;
      --table-border: #e9e9e9;
      --nav-bg: #0b0b0b;
      --nav-txt: #fff;
      --accent: #1976d2;
      --accent-contrast: #fff;
      --highlight: #fff5e6;
      --section-row: #f1f1f1;
      --table-head-bg: #fbfbfb;
      --calc-head: #1f4e78;
      --control-bg-disabled: #f7f7f7;
      --drag-halo: rgba(25,118,210,.14);
      --drag-border: #1976d2;

      /* Selected row (biru di light) & footer height */
      --row-selected: rgba(25,118,210,.14);
      --footer-h: 44px;
    }
    .theme-dark {
      color-scheme: dark;
      --bg: #1f1f1f;
      --txt: #eaeaea;
      --muted: #aaaaaa;
      --card: #262626;
      --border: #333;
      --table-border: #3a3a3a;
      --nav-bg: #151515;
      --nav-txt: #f2f2f2;
      --accent: #ff9f1a;
      --accent-contrast: #1a1a1a;
      --highlight: #2b2b2b;
      --section-row: #2a2a2a;
      --table-head-bg: #2a2a2a;
      --calc-head: #3a3a3a;
      --control-bg-disabled: #2a2a2a;
      --drag-halo: rgba(255,159,26,.22);
      --drag-border: #ff9f1a;

      /* Selected row (oranye di dark) */
      --row-selected: rgba(255,159,26,.18);
    }

    /* ===================== BASE ===================== */
    * { box-sizing: border-box }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--txt);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: var(--footer-h); /* ruang utk footer fixed */
    }
    main { flex: 1 0 auto;  }

    /* ===== Sticky Navbar ===== */
    .navbar-wrapper {
      background: var(--nav-bg);
      width: 100%;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255,255,255,.06);
      transition: box-shadow .18s ease, backdrop-filter .18s ease, background-color .18s ease;
    }
    .navbar-wrapper.is-stuck {
      box-shadow: 0 4px 14px rgba(0,0,0,.18);
      backdrop-filter: saturate(120%) blur(2px);
      background: color-mix(in oklab, var(--nav-bg) 92%, black);
    }

    .navbar { display: flex; align-items: center; gap: 16px; padding: 12px 0; }
    .brand { font-weight: 700; color: var(--nav-txt) }
    .project-name { opacity: .9; color: var(--nav-txt); font-weight: 400 }
    .nav-actions { margin-left: auto; display: flex; gap: 8px; align-items: center }

    .btn { background: var(--accent); color: var(--accent-contrast); border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px }
    .btn[disabled] { opacity: .6; cursor: not-allowed; pointer-events: none; }
    .btn.secondary { background: #eee; color: #111; border: 1px solid #ccc }
    .theme-dark .btn.secondary { background: #2e2e2e; color: #eaeaea; border: 1px solid #3a3a3a }
    .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,.3); color: var(--nav-txt) }
    .theme-dark .btn.ghost { border-color: #444; color: var(--nav-txt) }

    .container { padding: 20px; max-width: 1200px; margin: 0 auto }

    /* Tabs + theme toggle */
    .tabs { display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-end; border-bottom: 1px solid var(--border); padding-bottom: 6px; justify-content: space-between; }
    .tabs-left { display: flex; gap: 8px; align-items: flex-end; }
    .tab-btn { background: transparent; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: #333; position: relative; transition: color .12s ease, background .12s ease; margin: 0; }
    .theme-dark .tab-btn { color: var(--txt) }
    .tab-btn:focus { outline: none; }
    .tab-btn.active { color: var(--accent); font-weight: 600; }
    .tab-btn.active::after { content: ""; position: absolute; left: 18%; right: 18%; bottom: -8px; height: 3px; background: var(--accent); border-radius: 2px; box-shadow: 0 1px 4px rgba(0,0,0,0.25); }

    form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 18px; align-items: center }
    input[type="text"], input[type="number"], input[list] { padding: 8px 10px; border-radius: 6px; border: 1px solid #d6d6d6; font-size: 14px; min-height: 36px; width: 120px; background: var(--card); color: var(--txt) }
    .theme-dark input[type="text"], .theme-dark input[type="number"], .theme-dark input[list] { border-color: #3a3a3a; }
    #itemName { flex: 1 }
    #projectSearch { flex: 1 }
    button[type="submit"] { align-self: center; width: 120px; }
    .form-disabled { opacity: .7; filter: grayscale(10%); }
    .form-disabled input, .form-disabled select, .form-disabled textarea { background: var(--control-bg-disabled); }

    .table-wrap { overflow: auto; background: var(--card); border-radius: 6px; padding: 8px; border: 1px solid var(--border) }
    table { width: 100%; border-collapse: collapse; background: transparent }
    th, td { border: 1px solid var(--table-border); padding: 8px; text-align: center; font-size: 13px; color: var(--txt) }
    th { background: var(--table-head-bg); font-weight: 700 }
    td.left { text-align: left }
    tfoot .total { background: var(--highlight); font-weight: 700 }
    #cogsTable tfoot td.total.label, #sellingTable tfoot td.total.label { text-align: center; }
    #cogsTable tfoot td.total.value, #sellingTable tfoot td.total.value { text-align: right; }
    tr.section-row td { background: var(--section-row); font-weight: 700; text-align: left; padding-left: 12px; border-top: 2px solid var(--border) }

    /* Selected row via CSS variable */
    tr.selected { background: var(--row-selected); }

    /* ===== Drag & Drop ===== */
    tr.draggable { cursor: grab; }
    tr.dragging { opacity: .7; background: var(--drag-halo); }
    tr.drag-over { outline: 2px dashed var(--drag-border); outline-offset: -2px; }
    tr.section-row { user-select: none; }
    tr.section-row.draggable { cursor: grab; }
    tr.section-row.drag-over td { outline: 2px dashed var(--drag-border); outline-offset: -2px; }

    .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center }
    .actions label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted) }
    .small-note { font-size: 12px; color: var(--muted) }
    .hidden { display: none }

    /* modal */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background: var(--card); color: var(--txt); margin: 6% auto; padding: 16px; border-radius: 8px; width: 90%; max-width: 520px; box-shadow: 0 6px 18px rgba(0,0,0,0.2); border: 1px solid var(--border); }
    .modal-header { font-weight: 700; margin-bottom: 8px; display:flex; align-items:center; gap:8px; justify-content: space-between; flex-wrap: wrap; }
    .modal-header .title { font-weight:700; }
    .modal-search { margin: 0 12px; padding: 8px 10px; border-radius: 6px; border: 1px solid #d6d6d6; font-size: 14px; width: 55%; max-width: 340px; min-width: 160px; background: var(--card); color: var(--txt); }
    .theme-dark .modal-search { border-color: #3a3a3a; }
    .modal-list { max-height: 300px; overflow: auto; margin-bottom: 12px; padding: 0; list-style: none }
    .modal-list li { display: flex; gap: 8px; align-items: center; padding: 8px 4px; border-bottom: 1px solid var(--border) }
    .modal-list li span { flex: 1 }
    .modal-close { float: right; cursor: pointer; font-weight: 700; padding: 4px 8px; border-radius: 6px; background: #eee; border: 1px solid #ddd }
    .theme-dark .modal-close { background: #2d2d2d; border-color: #3a3a3a; color: var(--txt); }
    .calc-summary thead th { text-align: center; }
    .calc-summary tbody td.value { font-weight: 400; text-align: center; min-width: 140px; }
    .commission-input { width: 120px; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; text-align: center; background: var(--card); color: var(--txt); }
    .theme-dark .commission-input { border-color: #3a3a3a; }
    .modal .btn.ghost { background: transparent; border: 1px solid #ccc; color: #333; padding: 8px 12px; }
    .theme-dark .modal .btn.ghost { border-color: #3a3a3a; color: var(--txt); }

    /* ===================== THEME SLIDER BUTTON (bukan checkbox) ===================== */
    .theme-toggle { display: inline-flex; align-items: center; gap: 8px; color: var(--txt); user-select: none; }
    .toggle-label { font-size: 12px; opacity: .9; }
    .theme-dark .toggle-label { opacity: .95; }

    .switch {
      position: relative;
      width: 56px; height: 28px;
      background: #8c8c8c;
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease;
      display: inline-block;
    }
    .theme-dark .switch { background: #3a3a3a; border-color: #444; }
    .switch .slider {
      position: absolute; top: 1.2px; left: 2px;
      width: 24px; height: 24px; border-radius: 50%;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,.25);
      transition: transform .2s ease, background .2s ease, box-shadow .2s ease;
      will-change: transform;
    }
    .theme-dark .switch .slider { background: #f0f0f0; }
    /* Saat ON (dark) knob geser kanan + aksen */
    .switch.on { background: #3a3a3a; }
    .switch.on .slider { transform: translateX(28px); background: #ff9f1a; box-shadow: 0 1px 4px rgba(255,159,26,.5); }

    /* ===================== FOOTER (FIXED & SPLIT) ===================== */
    .app-footer {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      z-index: 1000; height: var(--footer-h);
      display: flex; align-items: center; width: 100%;
    }
    .app-footer .container {
  width: 100%;
  padding-top: 0;
  padding-bottom: 0;
}
    .footer-inner {
      font-size: 13px; color: var(--muted);
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
    }
    .footer-right { white-space: nowrap; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar-wrapper" id="navbarWrapper">
    <div class="container navbar">
      <div class="brand">BOQ Manager <span class="project-name" id="navProject">(no project)</span></div>
      <div class="nav-actions">
        <button class="btn ghost" id="renameProjectBtn" title="Rename project">Rename</button>
        <button class="btn ghost" id="manageBtn">Manage</button>
        <button class="btn secondary" id="downloadJSON" title="Backup semua data (projects, items, working, commission)">Backup</button>
        <button class="btn secondary" id="restoreJSON" title="Restore dari file backup JSON">Restore</button>
        <input type="file" id="restoreInput" accept=".json,application/json" style="display:none" />
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <main>
    <div class="container">
      <!-- Tabs + Theme Toggle Row -->
      <div class="tabs" role="tablist" aria-label="Primary tabs">
        <div class="tabs-left">
          <button class="tab-btn active" id="tabCogsBtn" role="tab" aria-selected="true">COGS</button>
          <button class="tab-btn" id="tabSellingBtn" role="tab" aria-selected="false">Selling</button>
          <button class="tab-btn" id="tabCalcBtn" role="tab" aria-selected="false">Calculation</button>
        </div>
        <div class="theme-toggle" title="Toggle dark mode">
          <span class="toggle-label" id="toggleLabel">Light</span>
          <!-- Slider Button (bukan checkbox) -->
          <button id="themeSwitchBtn" class="switch" role="button" aria-pressed="false" aria-label="Toggle dark mode">
            <span class="slider" aria-hidden="true"></span>
          </button>
        </div>
      </div>

      <form id="boqForm" autocomplete="off">
        <input type="text" id="itemName" placeholder="Item Name" list="itemList" required />
        <datalist id="itemList"></datalist>
        <input type="number" id="qty" placeholder="Qty" />
        <input type="text" id="unit" placeholder="Unit" />
        <input type="text" id="price" placeholder="COGS" />
        <input type="number" id="margin" placeholder="Margin (%)" min="0" max="999.99" step="0.01" />
        <input type="text" id="sellingInput" placeholder="Selling Price" />
        <input type="text" id="category" placeholder="Category" required />
        <button type="submit" class="btn">Add / Update</button>
      </form>

      <div id="tabCogs" class="tab-panel">
        <div class="table-wrap">
          <table id="cogsTable" aria-label="COGS table">
            <thead><tr><th>No</th><th>Nama Item</th><th>Qty</th><th>Unit</th><th>Harga COGS</th><th>Total COGS</th><th>Margin (%)</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="6" class="total label">Grand Total COGS</td><td class="total value" id="grandCogs">0</td></tr></tfoot>
          </table>
        </div>
      </div>

      <div id="tabSelling" class="tab-panel hidden">
        <div class="table-wrap">
          <table id="sellingTable" aria-label="Selling table">
            <thead><tr><th>No</th><th>Nama Item</th><th>Qty</th><th>Unit</th><th>Harga Satuan</th><th>Total</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="5" class="total label">Grand Total</td><td class="total value" id="grandSelling">0</td></tr></tfoot>
          </table>
        </div>
      </div>

      <div id="tabCalc" class="tab-panel hidden">
        <div class="table-wrap">
          <table id="calcSummary" class="calc-summary" aria-label="Calculation summary">
            <thead><tr><th>Total COGS</th><th>Total Selling</th><th>Commission</th><th>Gross Profit</th><th>Total Margin</th></tr></thead>
            <tbody>
              <tr>
                <td id="calcTotalCogs" class="value">0</td>
                <td id="calcTotalSelling" class="value">0</td>
                <td id="calcCommissionCell" class="value"><input id="commissionCellInput" class="commission-input" type="text" placeholder="0" /></td>
                <td id="calcGrossProfit" class="value">0</td>
                <td id="calcTotalMargin" class="value">0.00%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="actions">
        <button id="editBtn" class="btn secondary" type="button">Edit</button>
        <button class="btn secondary" id="deleteBtn" type="button">Delete</button>
        <button class="btn secondary" type="button" id="reorderBtn" title="Aktifkan drag & drop untuk ubah urutan">Reorder</button>
        <button class="btn" type="button" id="exportExcelBtn">Export Excel</button>
        <button class="btn" type="button" id="exportPdfBtn">Export PDF</button>
        <input list="projectList" id="projectSearch" placeholder="Search project..." autocomplete="off" />
        <datalist id="projectList"></datalist>
        <button class="btn secondary" type="button" id="loadProjectBtn">Load Project</button>
        <button class="btn secondary" type="button" id="saveProjectBtn">Save Project</button>
        <button class="btn" type="button" id="newProjectBtn">New Project</button>
      </div>
    </div>
  </main>

  <!-- ====== FOOTER (fixed & split) ====== -->
  <footer class="app-footer" role="contentinfo" aria-label="Footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-left">Â© 2025 BOQ Manager. All rights reserved. Developed by <b>Wahyu</b>.</div>
        <div class="footer-right">
          <span>Last updated:</span>
          <span id="lastSavedText">â€”</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal Management -->
  <div id="manageModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" id="modalClose">&times;</button>
      <div class="modal-header">
        <div class="title">Manage Items</div>
        <input id="manageItemSearch" class="modal-search" type="text" placeholder="Cari item..." />
      </div>
      <ul id="manageItemList" class="modal-list"></ul>
      <div style="text-align:right">
        <button class="btn secondary" id="manageProjectsBtn">Manage Projects</button>
      </div>
    </div>
  </div>

  <!-- Modal Projects -->
  <div id="projectsModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" id="projectsClose">&times;</button>
      <div class="modal-header">
        <div class="title">Manage Projects</div>
        <input id="manageProjectSearch" class="modal-search" type="text" placeholder="Cari project..." />
      </div>
      <ul id="manageProjectList" class="modal-list"></ul>
    </div>
  </div>

  <script>
    // ===== Sticky navbar shadow toggler =====
    const navbarWrapper = document.getElementById('navbarWrapper');
    const setStickinessShadow = () => {
      if (window.scrollY > 2) navbarWrapper.classList.add('is-stuck');
      else navbarWrapper.classList.remove('is-stuck');
    };
    setStickinessShadow();
    window.addEventListener('scroll', setStickinessShadow, { passive: true });

    // ===== STATE & HELPERS =====
    const tabCogsBtn = document.getElementById('tabCogsBtn');
    const tabSellingBtn = document.getElementById('tabSellingBtn');
    const tabCalcBtn = document.getElementById('tabCalcBtn');
    const tabCogs = document.getElementById('tabCogs');
    const tabSelling = document.getElementById('tabSelling');
    const tabCalc = document.getElementById('tabCalc');
    const form = document.getElementById('boqForm');

    // Theme switch (slider button)
    const themeSwitchBtn = document.getElementById('themeSwitchBtn');
    const toggleLabel = document.getElementById('toggleLabel');

    function applyTheme(theme) {
      const root = document.documentElement;
      const isDark = theme === 'dark';
      root.classList.toggle('theme-dark', isDark);
      toggleLabel.textContent = isDark ? 'Dark' : 'Light';
      themeSwitchBtn.classList.toggle('on', isDark);
      themeSwitchBtn.setAttribute('aria-pressed', String(isDark));
      localStorage.setItem('boq_theme', isDark ? 'dark' : 'light');
    }
    (function initTheme(){
      const saved = localStorage.getItem('boq_theme');
      if (saved === 'dark' || saved === 'light') applyTheme(saved);
      else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
      else applyTheme('light');
    })();
    // Click & keyboard toggle
    themeSwitchBtn.addEventListener('click', () => {
      applyTheme(document.documentElement.classList.contains('theme-dark') ? 'light' : 'dark');
    });
    themeSwitchBtn.addEventListener('keydown', (e) => {
      if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); themeSwitchBtn.click(); }
    });

    let activeTab = 'cogs';
    function setFormDisabled(disabled) {
      const controls = form.querySelectorAll('input, button, select, textarea');
      controls.forEach(el => { if (el.tagName.toLowerCase() !== 'datalist') disabled ? el.setAttribute('disabled','disabled') : el.removeAttribute('disabled'); });
      form.classList.toggle('form-disabled', disabled);
    }
    function switchTo(tab) {
      activeTab = tab;
      tabCogs.classList.add('hidden'); tabSelling.classList.add('hidden'); tabCalc.classList.add('hidden');
      [tabCogsBtn, tabSellingBtn, tabCalcBtn].forEach(btn => { btn.classList.remove('active'); btn.setAttribute('aria-selected','false'); });
      if (tab === 'cogs') { tabCogs.classList.remove('hidden'); tabCogsBtn.classList.add('active'); tabCogsBtn.setAttribute('aria-selected','true'); setFormDisabled(false); }
      else if (tab === 'selling') { tabSelling.classList.remove('hidden'); tabSellingBtn.classList.add('active'); tabSellingBtn.setAttribute('aria-selected','true'); setFormDisabled(true); }
      else { tabCalc.classList.remove('hidden'); tabCalcBtn.classList.add('active'); tabCalcBtn.setAttribute('aria-selected','true'); setFormDisabled(true); renderCalculation(); }
    }
    tabCogsBtn.addEventListener('click', () => switchTo('cogs'));
    tabSellingBtn.addEventListener('click', () => switchTo('selling'));
    tabCalcBtn.addEventListener('click', () => switchTo('calculation'));

    const itemList = document.getElementById('itemList');
    const priceInput = document.getElementById('price');
    const marginInput = document.getElementById('margin');
    const sellingInput = document.getElementById('sellingInput');
    const qtyInput = document.getElementById('qty');
    const unitInput = document.getElementById('unit');
    const categoryInput = document.getElementById('category');
    const nameInput = document.getElementById('itemName');
    const grandCogsEl = document.getElementById('grandCogs');
    const grandSellingEl = document.getElementById('grandSelling');
    const projectSearch = document.getElementById('projectSearch');
    const projectList = document.getElementById('projectList');
    const navProject = document.getElementById('navProject');
    const renameProjectBtn = document.getElementById('renameProjectBtn');
    const downloadJSONBtn = document.getElementById('downloadJSON');
    const restoreJSONBtn = document.getElementById('restoreJSON');
    const restoreInput = document.getElementById('restoreInput');
    const manageBtn = document.getElementById('manageBtn');
    const manageModal = document.getElementById('manageModal');
    const projectsModal = document.getElementById('projectsModal');
    const modalClose = document.getElementById('modalClose');
    const projectsClose = document.getElementById('projectsClose');
    const manageItemList = document.getElementById('manageItemList');
    const manageProjectsBtn = document.getElementById('manageProjectsBtn');
    const manageProjectList = document.getElementById('manageProjectList');

    const manageItemSearch = document.getElementById('manageItemSearch');
    const manageProjectSearch = document.getElementById('manageProjectSearch');

    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const loadProjectBtn = document.getElementById('loadProjectBtn');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const newProjectBtn = document.getElementById('newProjectBtn');

    const calcTotalCogsEl = document.getElementById('calcTotalCogs');
    const calcTotalSellingEl = document.getElementById('calcTotalSelling');
    const commissionCellInput = document.getElementById('commissionCellInput');
    const calcGrossProfitEl = document.getElementById('calcGrossProfit');
    const calcTotalMarginEl = document.getElementById('calcTotalMargin');

    const lastSavedTextEl = document.getElementById('lastSavedText');

    let items = JSON.parse(localStorage.getItem('boq_items')) || [];
    let tableData = JSON.parse(localStorage.getItem('boq_working')) || [];
    let selectedIndex = null;
    let editingIndex = null;
    let sellingInputManuallyEdited = false;
    let currentProjectName = localStorage.getItem('boq_current_name') || "";
    const PROJECTS_KEY = 'boq_projects_v2';
    const UNSAVED_COMM_KEY = 'boq_unsaved_commission';

    // ===== Reorder mode =====
    const reorderBtn = document.getElementById('reorderBtn');
    let reorderMode = false;
    function updateReorderButton() {
      reorderBtn.textContent = reorderMode ? 'Done Reorder' : 'Reorder';
      reorderBtn.classList.toggle('secondary', !reorderMode);
      reorderBtn.title = reorderMode ? 'Selesai ubah urutan' : 'Aktifkan drag & drop untuk ubah urutan';
    }
    function clearDragVisuals() {
      document.querySelectorAll('.drag-over, .dragging').forEach(el => el.classList.remove('drag-over','dragging'));
    }
    function setReorderMode(on) {
      reorderMode = !!on;
      clearDragVisuals();
      updateReorderButton();
      renderAll();
    }
    reorderBtn.addEventListener('click', () => setReorderMode(!reorderMode));

    // ===== Category order =====
    let categoryOrder = JSON.parse(localStorage.getItem('boq_category_order')) || [];
    function getAllCategories() {
      const set = [];
      tableData.forEach(r => {
        const c = sanitize(r.category || 'Uncategorized');
        if (!set.includes(c)) set.push(c);
      });
      return set;
    }
    function normalizeCategoryOrder() {
      const cats = getAllCategories();
      categoryOrder = categoryOrder.filter(c => cats.includes(c));
      cats.forEach(c => { if (!categoryOrder.includes(c)) categoryOrder.push(c); });
      localStorage.setItem('boq_category_order', JSON.stringify(categoryOrder));
      if (currentProjectName) {
        const projects = loadProjectsObj();
        if (projects[currentProjectName]) {
          projects[currentProjectName].categoryOrder = categoryOrder.slice();
          saveProjectsObj(projects);
        }
      }
    }

    let currentCommission = 0;

    function sanitize(s) { return String(s || '').replace(/<\/?[^>]+(>|$)/g, "").trim(); }
    function getSafeFileName(name) { if (!name) return 'BOQ'; return (`BOQ - ${name}`).replace(/[\\\/:*?"<>|]/g, '').trim(); }
    function updateNavProject() { navProject.textContent = currentProjectName ? `| ${currentProjectName}` : '(no project)'; }
    function showAlert(msg) { alert(msg); }
    function parseNumberFormatted(str) { if (str == null) return null; const raw = String(str).replace(/\./g,'').replace(/,/g,'').trim(); return raw === '' ? null : Number(raw); }
    function formatThousandsInput(el) { el.addEventListener('input', () => { const raw = String(el.value).replace(/[^\d]/g,''); el.value = raw ? Number(raw).toLocaleString('id-ID') : ''; }); }
    formatThousandsInput(priceInput);
    formatThousandsInput(sellingInput);

    function excelColLetter(n) { let s=''; while (n>0) { const m = (n-1) % 26; s = String.fromCharCode(65+m) + s; n = Math.floor((n-1)/26); } return s; }

    function updateDatalist() {
      const map = {};
      items.forEach(it => { if (!it || !it.name) return; const key = it.name.trim(); if (!map[key] || (it.updatedAt && map[key].updatedAt < it.updatedAt)) map[key] = it; });
      const arr = Object.values(map).slice().sort((a,b) => (a.name||'').toLowerCase().localeCompare((b.name||'').toLowerCase()));
      itemList.innerHTML = '';
      arr.forEach(it => { const opt = document.createElement('option'); opt.value = it.name; itemList.appendChild(opt); });
    }

    function calcSellingPrice(cogs, marginPercent) { const m = Number(marginPercent)/100; if (!isFinite(m) || m >= 1) return null; if (cogs === "" || cogs == null) return null; return Number(cogs) / (1 - m); }
    function roundUpToThousand(n) { if (n == null || !isFinite(n)) return null; const eps = 1e-9; return Math.ceil((n - eps) / 1000) * 1000; }

    function normalizeKey(name) { return String(name || '').trim().toLowerCase(); }
    function getItemByName(name) { if (!name) return null; const key = normalizeKey(name); let best = null; for (const it of items) { if (!it || !it.name) continue; if (normalizeKey(it.name) === key) { if (!best || (it.updatedAt || 0) > (best.updatedAt || 0)) best = it; } } return best; }

    function updateItemsWithEntry(name, unit, price, sellingPrice, category) {
      if (!name) return;
      const key = normalizeKey(name);
      let foundIndex = -1;
      for (let i = 0; i < items.length; i++) { if (normalizeKey(items[i].name) === key) { foundIndex = i; break; } }
      const now = Date.now();
      if (foundIndex >= 0) {
        const it = items[foundIndex];
        if (unit !== undefined) it.unit = unit;
        if (price !== undefined) it.price = price;
        if (sellingPrice !== undefined) it.sellingPrice = sellingPrice;
        if (category !== undefined) it.category = category;
        it.updatedAt = now;
        items[foundIndex] = it;
      } else {
        items.push({ name, unit: unit||"", price: (price!==undefined && price!==null)?price:"", sellingPrice: (sellingPrice!==undefined && sellingPrice!==null)?sellingPrice:"", category: category||"", updatedAt: now });
      }
      const map = {};
      items.forEach(it => { const k = normalizeKey(it.name); if (!map[k] || (it.updatedAt || 0) > (map[k].updatedAt || 0)) map[k] = it; });
      items = Object.values(map).sort((a,b) => (b.updatedAt||0)-(a.updatedAt||0));
      localStorage.setItem('boq_items', JSON.stringify(items));
      updateDatalist();
    }

    function autofillFromItem(name) {
      const it = getItemByName(name);
      if (!it) return;
      if (it.unit !== undefined) unitInput.value = it.unit || "";
      if (it.price !== undefined && it.price !== "" && it.price !== null) {
        priceInput.value = Number(it.price).toLocaleString('id-ID');
        sellingInputManuallyEdited = false;
        computeAndDisplaySelling();
      } else {
        priceInput.value = '';
        if (it.sellingPrice !== undefined && it.sellingPrice !== "" && it.sellingPrice !== null) {
          sellingInput.value = Number(it.sellingPrice).toLocaleString('id-ID');
          sellingInputManuallyEdited = false;
        } else {
          sellingInput.value = '';
          sellingInputManuallyEdited = false;
        }
      }
      if (it.category !== undefined) categoryInput.value = it.category || "";
    }

    nameInput.addEventListener('change', (e) => {
      const v = sanitize(e.target.value);
      if (!v) return;
      const found = getItemByName(v);
      if (found) autofillFromItem(v);
    });

    sellingInput.addEventListener('input', () => { sellingInputManuallyEdited = true; });
    function computeAndDisplaySelling() {
      const priceNum = parseNumberFormatted(priceInput.value);
      const marginNum = (marginInput.value !== '') ? Number(marginInput.value) : null;
      if ((priceNum != null && priceNum !== '') && (marginNum != null && isFinite(marginNum) && marginNum < 100)) {
        const spRaw = calcSellingPrice(Number(priceNum), Number(marginNum));
        const spRounded = (spRaw != null) ? roundUpToThousand(spRaw) : null;
        if (!sellingInputManuallyEdited) { if (spRounded != null) sellingInput.value = Number(spRounded).toLocaleString('id-ID'); else sellingInput.value = ''; }
      } else { if (!sellingInputManuallyEdited) sellingInput.value = ''; }
    }
    priceInput.addEventListener('input', computeAndDisplaySelling);
    marginInput.addEventListener('input', computeAndDisplaySelling);

    function computeTotals() {
      const totalCogs = tableData.reduce((acc, r) => { const p = (r.price != null && r.price !== "") ? Number(r.price) : 0; const q = Number(r.qty || 0); return acc + (Number(p || 0) * q); }, 0);
      const totalSelling = tableData.reduce((acc, r) => { let sp = null; if (r.sellingPrice != null && r.sellingPrice !== "") sp = Number(r.sellingPrice); else if (r.price != null && r.price !== "") sp = calcSellingPrice(Number(r.price), r.margin); const spr = sp != null ? roundUpToThousand(sp) : 0; const q = Number(r.qty || 0); return acc + (spr ? (spr * q) : 0); }, 0);
      return { totalCogs, totalSelling };
    }

    /* ===== Drag & Drop State ===== */
    const dragState = { type: null, cat: null, fromPos: null, fromCat: null };

    function moveItemInCategory(category, fromPos, toPos) {
      if (fromPos === toPos) return;
      const cat = sanitize(category || 'Uncategorized');
      const indices = [];
      tableData.forEach((r, i) => { if (sanitize(r.category || 'Uncategorized') === cat) indices.push(i); });
      if (!indices.length) return;
      if (fromPos < 0 || fromPos >= indices.length || toPos < 0 || toPos >= indices.length) return;

      const fromIndex = indices[fromPos];
      const [item] = tableData.splice(fromIndex, 1);

      const indicesAfter = [];
      tableData.forEach((r, i) => { if (sanitize(r.category || 'Uncategorized') === cat) indicesAfter.push(i); });
      const toIndex = indicesAfter[toPos];

      tableData.splice(toIndex, 0, item);

      localStorage.setItem('boq_working', JSON.stringify(tableData));
      renderAll();
      persistProject(); // update last saved
    }

    function addRowDragHandlers(tr, cat, posInCat) {
      tr.classList.add('draggable');
      tr.setAttribute('draggable', 'true');

      tr.addEventListener('dragstart', (e) => {
        dragState.type = 'row';
        dragState.cat = cat;
        dragState.fromPos = posInCat;
        tr.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        try { e.dataTransfer.setData('text/plain', `row|${cat}|${posInCat}`); } catch(_) {}
      });

      tr.addEventListener('dragend', () => {
        tr.classList.remove('dragging');
        document.querySelectorAll('tr.drag-over').forEach(x => x.classList.remove('drag-over'));
        dragState.type = null; dragState.cat = null; dragState.fromPos = null;
      });

      tr.addEventListener('dragover', (e) => {
        if (dragState.type === 'row' && dragState.cat === cat) {
          e.preventDefault();
          tr.classList.add('drag-over');
          e.dataTransfer.dropEffect = 'move';
        }
      });

      tr.addEventListener('dragleave', () => tr.classList.remove('drag-over'));

      tr.addEventListener('drop', (e) => {
        e.preventDefault();
        tr.classList.remove('drag-over');
        if (!(dragState.type === 'row' && dragState.cat === cat && dragState.fromPos != null)) return;
        const toPos = posInCat;
        moveItemInCategory(cat, dragState.fromPos, toPos);
      });
    }

    // ===== Section (Category) drag handlers =====
    function addSectionDragHandlers(trSec, cat) {
      trSec.classList.add('draggable');
      trSec.setAttribute('draggable','true');

      trSec.addEventListener('dragstart', (e) => {
        dragState.type = 'group';
        dragState.fromCat = cat;
        trSec.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        try { e.dataTransfer.setData('text/plain', `group|${cat}`); } catch(_) {}
      });

      trSec.addEventListener('dragend', () => {
        trSec.classList.remove('dragging');
        document.querySelectorAll('tr.section-row.drag-over').forEach(x => x.classList.remove('drag-over'));
        dragState.type = null; dragState.fromCat = null;
      });

      trSec.addEventListener('dragover', (e) => {
        if (dragState.type === 'group') {
          e.preventDefault();
          trSec.classList.add('drag-over');
          e.dataTransfer.dropEffect = 'move';
        }
      });

      trSec.addEventListener('dragleave', () => trSec.classList.remove('drag-over'));

      trSec.addEventListener('drop', (e) => {
        e.preventDefault();
        trSec.classList.remove('drag-over');
        if (dragState.type !== 'group' || !dragState.fromCat) return;
        const fromIdx = categoryOrder.indexOf(dragState.fromCat);
        const toIdx = categoryOrder.indexOf(cat);
        if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
        const [moved] = categoryOrder.splice(fromIdx, 1);
        categoryOrder.splice(toIdx, 0, moved);
        localStorage.setItem('boq_category_order', JSON.stringify(categoryOrder));
        persistProject(); // update last saved
        renderAll();
      });
    }

    /* ===== Rendering Tables ===== */
    function buildGroupedByCategory() {
      const grouped = {};
      tableData.forEach(r => {
        const cat = sanitize(r.category || 'Uncategorized');
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(r);
      });
      normalizeCategoryOrder();
      return { grouped, orderedCats: categoryOrder.slice() };
    }

    function renderCogsTable() {
      const cogsTbody = document.querySelector('#cogsTable tbody');
      cogsTbody.innerHTML = '';
      const { grouped, orderedCats } = buildGroupedByCategory();
      let idx = 1; let grand = 0;

      orderedCats.forEach(cat => {
        const trSec = document.createElement('tr'); trSec.className = 'section-row';
        trSec.dataset.cat = cat;
        const tdSec = document.createElement('td'); tdSec.colSpan = 7; tdSec.textContent = cat;
        trSec.appendChild(tdSec);
        if (reorderMode) addSectionDragHandlers(trSec, cat);
        cgsTbodyAppend(trSec, cogsTbody);

        (grouped[cat] || []).forEach((row, posInCat) => {
          const tr = document.createElement('tr');

          const tdNo = document.createElement('td'); tdNo.textContent = idx++;
          const tdName = document.createElement('td'); tdName.className = 'left'; tdName.textContent = sanitize(row.name);
          const tdQty = document.createElement('td'); tdQty.textContent = row.qty !== "" ? row.qty : "";
          const tdUnit = document.createElement('td'); tdUnit.textContent = row.unit || "";
          const tdCogs = document.createElement('td'); tdCogs.style.textAlign = 'right';
          const tdTotal = document.createElement('td'); tdTotal.style.textAlign = 'right';
          const tdMargin = document.createElement('td'); tdMargin.style.textAlign = 'right';

          const priceNum = (row.price != null && row.price !== "") ? Number(row.price) : null;
          const qtyNum = (row.qty != null && row.qty !== "") ? Number(row.qty) : null;
          const totalCogs = (priceNum != null && qtyNum != null) ? Number(priceNum) * Number(qtyNum) : null;
          tdCogs.textContent = (priceNum != null && isFinite(priceNum)) ? Number(priceNum).toLocaleString('id-ID') : "";
          tdTotal.textContent = (totalCogs != null && isFinite(totalCogs)) ? Number(totalCogs).toLocaleString('id-ID') : "";
          tdMargin.textContent = (row.margin != null && row.margin !== "") ? Number(row.margin).toFixed(2) : "";
          if (totalCogs != null && isFinite(totalCogs)) grand += Number(totalCogs);

          tr.appendChild(tdNo); tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdUnit); tr.appendChild(tdCogs); tr.appendChild(tdTotal); tr.appendChild(tdMargin);

          tr.addEventListener('click', () => {
            selectedIndex = tableData.indexOf(row);
            document.querySelectorAll('#cogsTable tbody tr, #sellingTable tbody tr').forEach(r => r.classList.remove('selected'));
            tr.classList.add('selected');
          });

          if (reorderMode) addRowDragHandlers(tr, cat, posInCat);

          cgsTbodyAppend(tr, cogsTbody);
        });
      });
      grandCogsEl.textContent = grand.toLocaleString('id-ID');
    }
    // small helper to avoid layout thrash
    function cgsTbodyAppend(node, tbody){ tbody.appendChild(node); }

    function renderSellingTable() {
      const sellingTbody = document.querySelector('#sellingTable tbody');
      sellingTbody.innerHTML = '';
      const { grouped, orderedCats } = buildGroupedByCategory();
      let idx = 1; let grand = 0;

      orderedCats.forEach(cat => {
        const trSec = document.createElement('tr'); trSec.className = 'section-row';
        trSec.dataset.cat = cat;
        const tdSec = document.createElement('td'); tdSec.colSpan = 6; tdSec.textContent = cat;
        trSec.appendChild(tdSec);
        if (reorderMode) addSectionDragHandlers(trSec, cat);
        sellingTbody.appendChild(trSec);

        (grouped[cat] || []).forEach((row, posInCat) => {
          const tr = document.createElement('tr');

          const tdNo = document.createElement('td'); tdNo.textContent = idx++;
          const tdName = document.createElement('td'); tdName.className = 'left'; tdName.textContent = sanitize(row.name);
          const tdQty = document.createElement('td'); tdQty.textContent = row.qty !== "" ? row.qty : "";
          const tdUnit = document.createElement('td'); tdUnit.textContent = row.unit || "";
          const tdSelling = document.createElement('td'); tdSelling.style.textAlign = 'right';
          const tdTotalSelling = document.createElement('td'); tdTotalSelling.style.textAlign = 'right';

          let sellingPriceRaw = null;
          if (row.sellingPrice != null && row.sellingPrice !== "") sellingPriceRaw = Number(row.sellingPrice);
          else { const priceNum = (row.price != null && row.price !== "") ? Number(row.price) : null; sellingPriceRaw = (priceNum != null) ? calcSellingPrice(priceNum, row.margin) : null; }
          const sellingPriceRounded = sellingPriceRaw != null ? roundUpToThousand(sellingPriceRaw) : null;
          const qtyNum = (row.qty != null && row.qty !== "") ? Number(row.qty) : null;
          const totalSelling = (sellingPriceRounded != null && qtyNum != null) ? Number(sellingPriceRounded) * Number(qtyNum) : null;
          tdSelling.textContent = (sellingPriceRounded != null && isFinite(sellingPriceRounded)) ? Number(sellingPriceRounded).toLocaleString('id-ID') : "";
          tdTotalSelling.textContent = (totalSelling != null && isFinite(totalSelling)) ? Number(totalSelling).toLocaleString('id-ID') : "";
          if (totalSelling != null && isFinite(totalSelling)) grand += Number(totalSelling);

          tr.appendChild(tdNo); tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdUnit); tr.appendChild(tdSelling); tr.appendChild(tdTotalSelling);

          tr.addEventListener('click', () => {
            selectedIndex = tableData.indexOf(row);
            document.querySelectorAll('#cogsTable tbody tr, #sellingTable tbody tr').forEach(r => r.classList.remove('selected'));
            tr.classList.add('selected');
          });

          if (reorderMode) addRowDragHandlers(tr, cat, posInCat);

          sellingTbody.appendChild(tr);
        });
      });
      grandSellingEl.textContent = grand.toLocaleString('id-ID');
    }

    function loadProjectsObj() { try { return JSON.parse(localStorage.getItem(PROJECTS_KEY)) || {}; } catch (e) { return {}; } }
    function saveProjectsObj(obj) { localStorage.setItem(PROJECTS_KEY, JSON.stringify(obj)); }

    function renderCalculation() {
      const totals = computeTotals();
      const totalCogs = totals.totalCogs || 0;
      const totalSelling = totals.totalSelling || 0;
      const commission = Number(currentCommission || 0);
      const grossProfit = totalSelling - totalCogs - commission;
      const totalMargin = (totalSelling === 0) ? 0 : (grossProfit / totalSelling);
      calcTotalCogsEl.textContent = Number(totalCogs || 0).toLocaleString('id-ID');
      calcTotalSellingEl.textContent = Number(totalSelling || 0).toLocaleString('id-ID');
      commissionCellInput.value = commission ? Number(commission).toLocaleString('id-ID') : '';
      calcGrossProfitEl.textContent = Number(grossProfit || 0).toLocaleString('id-ID');
      calcTotalMarginEl.textContent = (isFinite(totalMargin) ? (totalMargin * 100).toFixed(2) : '0.00') + '%';
    }

    (function setupCommissionCell() {
      commissionCellInput.addEventListener('input', () => {
        const rawDigits = String(commissionCellInput.value).replace(/[^\d]/g, '');
        commissionCellInput.value = rawDigits ? Number(rawDigits).toLocaleString('id-ID') : '';
        const parsed = parseNumberFormatted(commissionCellInput.value) || 0;
        currentCommission = Number(parsed);
        persistProject(); // update last saved
        renderCalculation();
      });
    })();

    function loadCommissionForCurrentProject() {
      if (currentProjectName) {
        const projects = loadProjectsObj();
        const p = projects[currentProjectName];
        if (p && typeof p === 'object') { currentCommission = Number(p.commission || 0); return; }
      }
      const unsaved = parseNumberFormatted(localStorage.getItem(UNSAVED_COMM_KEY));
      currentCommission = unsaved != null ? Number(unsaved) : 0;
    }

    /* ===== Last Saved UI (label tampil: Last Updated) ===== */
    function formatLastSaved(ts) {
      if (!ts) return 'â€”';
      try {
        return new Date(ts).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
      } catch { return 'â€”'; }
    }
    function updateFooterLastSaved() {
      if (!currentProjectName) { lastSavedTextEl.textContent = 'â€”'; return; }
      const projects = loadProjectsObj();
      const p = projects[currentProjectName];
      lastSavedTextEl.textContent = p && p.lastSaved ? formatLastSaved(p.lastSaved) : 'â€”';
    }

    function persistProject() {
      if (currentProjectName) {
        const projects = loadProjectsObj();
        projects[currentProjectName] = {
          data: tableData,
          commission: Number(currentCommission || 0),
          categoryOrder: categoryOrder.slice(),
          lastSaved: Date.now()   // update last saved setiap perubahan data
        };
        saveProjectsObj(projects);
        updateFooterLastSaved();
      } else {
        if (currentCommission === 0) localStorage.removeItem(UNSAVED_COMM_KEY);
        else localStorage.setItem(UNSAVED_COMM_KEY, String(currentCommission));
      }
    }

    function renderAll() { normalizeCategoryOrder(); renderCogsTable(); renderSellingTable(); renderCalculation(); }

    function setEditingMode(idx) { editingIndex = (typeof idx === 'number') ? idx : null; updateEditButton(); }
    function cancelEdit() { setEditingMode(null); selectedIndex = null; sellingInputManuallyEdited = false; form.reset(); document.querySelectorAll('#cogsTable tbody tr, #sellingTable tbody tr').forEach(r => r.classList.remove('selected')); nameInput.focus(); }
    function updateEditButton() { editBtn.textContent = (editingIndex === null) ? 'Edit' : 'Cancel Edit'; }

    form.addEventListener('submit', e => {
      e.preventDefault();
      if (form.classList.contains('form-disabled')) return;

      const name = sanitize(nameInput.value);
      const category = sanitize(categoryInput.value);
      if (!name || !category) { showAlert('Nama item dan kategori harus diisi.'); return; }
      const qtyRaw = qtyInput.value;
      const qty = qtyRaw !== "" ? Number(qtyRaw) : "";
      const unit = sanitize(unitInput.value);
      const priceRaw = priceInput.value.replace(/\./g,'').replace(/,/g,'');
      const price = priceRaw !== "" ? Number(priceRaw) : "";
      const marginRaw = marginInput.value;
      const margin = marginRaw !== "" ? Number(marginRaw) : 0;
      const sellingRawStr = sellingInput.value.replace(/\./g,'').replace(/,/g,'');
      const sellingProvided = sellingRawStr !== "" ? Number(sellingRawStr) : "";
      if (margin >= 100) { if (!confirm('Margin 100% atau lebih akan membuat Harga Jual tidak terdefinisi. Lanjutkan?')) return; }
      const totalCogs = (qty !== "" && price !== "") ? Number(qty) * Number(price) : "";
      let sellingPriceComputed = "";
      if (sellingProvided !== "") sellingPriceComputed = sellingProvided;
      else if (price !== "" && margin < 100) { const sp = calcSellingPrice(price, margin); sellingPriceComputed = (sp != null) ? sp : ""; }
      else sellingPriceComputed = "";
      const sellingPriceRoundedForTotal = (sellingPriceComputed !== "" && sellingPriceComputed != null) ? roundUpToThousand(Number(sellingPriceComputed)) : "";
      const totalSelling = (qty !== "" && sellingPriceRoundedForTotal !== "" && sellingPriceRoundedForTotal != null) ? Number(qty) * Number(sellingPriceRoundedForTotal) : "";
      const newRow = { name, qty: qty !== "" ? qty : "", unit, price: price !== "" ? price : "", total: totalCogs !== "" ? totalCogs : "", margin: margin !== "" ? margin : 0, sellingPrice: (sellingPriceComputed !== "" && sellingPriceComputed != null) ? Number(sellingPriceComputed) : "", totalSellingPrice: (totalSelling !== "" && totalSelling != null) ? totalSelling : "", category };
      if (editingIndex !== null && typeof editingIndex === 'number') { tableData[editingIndex] = newRow; setEditingMode(null); } else { tableData.push(newRow); }
      selectedIndex = null; sellingInputManuallyEdited = false;
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      normalizeCategoryOrder();

      const storePrice = (price !== "" && price != null) ? Number(price) : "";
      const storeSelling = (sellingProvided !== "" && sellingProvided != null) ? Number(sellingProvided) : ((sellingPriceComputed !== "" && sellingPriceComputed != null) ? Number(sellingPriceComputed) : "");
      updateItemsWithEntry(name, unit || "", storePrice !== "" ? storePrice : "", storeSelling !== "" ? storeSelling : "", category || "");
      form.reset(); nameInput.focus(); renderAll();
      persistProject(); // update last saved
      updateEditButton();
    });

    editBtn.addEventListener('click', () => {
      if (editingIndex !== null) { cancelEdit(); updateEditButton(); return; }
      if (selectedIndex === null) { showAlert('Pilih baris dulu!'); return; }
      setEditingMode(selectedIndex);
      const r = tableData[selectedIndex];
      nameInput.value = r.name;
      qtyInput.value = r.qty !== "" ? r.qty : "";
      unitInput.value = r.unit || "";
      priceInput.value = r.price !== "" ? Number(r.price).toLocaleString('id-ID') : "";
      marginInput.value = (r.margin !== undefined && r.margin !== null) ? r.margin : "";
      sellingInputManuallyEdited = false;
      if (r.sellingPrice != null && r.sellingPrice !== "") sellingInput.value = Number(r.sellingPrice).toLocaleString('id-ID'); else sellingInput.value = '';
      computeAndDisplaySelling();
      categoryInput.value = r.category || "";
      switchTo('cogs'); nameInput.focus(); updateEditButton();
    });

    deleteBtn.addEventListener('click', () => {
      if (selectedIndex === null) { showAlert('Pilih baris dulu!'); return; }
      if (!confirm('Hapus baris ini?')) return;
      tableData.splice(selectedIndex, 1);
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      selectedIndex = null; setEditingMode(null);
      normalizeCategoryOrder();
      renderAll();
      persistProject(); // update last saved
      updateEditButton();
    });

    exportExcelBtn.addEventListener('click', exportExcel);
    exportPdfBtn.addEventListener('click', exportPDF);

    async function exportExcel() {
      const filename = getSafeFileName(currentProjectName) + ".xlsx";
      const workbook = new ExcelJS.Workbook();

      // SHEET: Selling
      const sheetSelling = workbook.addWorksheet("Selling");
      sheetSelling.columns = [
        { key: "no", width: 6 }, { key: "name", width: 40 }, { key: "qty", width: 10 },
        { key: "unit", width: 12 }, { key: "sellingPrice", width: 18 }, { key: "totalSelling", width: 18 }
      ];
      sheetSelling.insertRow(1, [currentProjectName ? `BOQ - ${currentProjectName}` : 'BOQ']);
      sheetSelling.insertRow(2, []);
      const lastColSell = sheetSelling.columns.length;
      sheetSelling.mergeCells(`A1:${excelColLetter(lastColSell)}1`);
      const tCellSell = sheetSelling.getRow(1).getCell(1);
      tCellSell.font = { name: 'Arial', bold: true };
      tCellSell.alignment = { horizontal: 'left', vertical: 'middle' };

      const headerSell = ["No","Nama Item","Qty","Unit","Harga Satuan","Total"];
      sheetSelling.insertRow(3, headerSell);
      const headerRowSell = sheetSelling.getRow(3);
      headerRowSell.eachCell((cell) => {
        cell.font = { name: 'Arial', bold: true, color: { argb: "FFFFFFFF" } };
        cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF1F4E78" } };
        cell.alignment = { horizontal: "center", vertical: "middle" };
        cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
      });

      const groupedS = {};
      tableData.forEach(r => { const cat = sanitize(r.category || "Uncategorized"); if (!groupedS[cat]) groupedS[cat] = []; groupedS[cat].push(r); });
      normalizeCategoryOrder();
      let noS = 1;
      categoryOrder.forEach(cat => {
        const secRow = sheetSelling.addRow([cat]);
        sheetSelling.mergeCells(`A${secRow.number}:${excelColLetter(lastColSell)}${secRow.number}`);
        for (let i=1;i<=lastColSell;i++){
          const cell = secRow.getCell(i);
          cell.font = { name: 'Arial', bold: true };
          cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFEEEEEE" } };
          cell.alignment = { horizontal: "left", vertical: "middle" };
          cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
        }
        (groupedS[cat]||[]).forEach(r => {
          let spRaw = null;
          if (r.sellingPrice != null && r.sellingPrice !== "") spRaw = Number(r.sellingPrice);
          else if (r.price != null && r.price !== "") spRaw = calcSellingPrice(Number(r.price), r.margin);
          const spRounded = spRaw != null ? roundUpToThousand(spRaw) : "";
          const totalSp = (spRounded !== "") ? Number(r.qty || 0) * spRounded : "";
          const rowObj = [noS++, r.name, r.qty, r.unit, (spRounded !== "" ? spRounded : ""), (totalSp !== "" ? totalSp : "")];
          const dr = sheetSelling.addRow(rowObj);
          dr.eachCell((cell, colNum) => {
            cell.font = { name: 'Arial' };
            cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
            if (colNum >= 5) { cell.numFmt = "#,##0"; cell.alignment = { horizontal: "right", vertical: "middle" }; }
            else if (colNum === 2) { cell.alignment = { horizontal: "left", vertical: "middle", wrapText: true }; }
            else { cell.alignment = { horizontal: "center", vertical: "middle" }; }
          });
        });
      });

      const sumSelling = tableData.reduce((a,b) => {
        let sp = null;
        if (b.sellingPrice != null && b.sellingPrice !== "") sp = Number(b.sellingPrice);
        else if (b.price != null && b.price !== "") sp = calcSellingPrice(Number(b.price), b.margin);
        const spr = sp != null ? roundUpToThousand(sp) : 0;
        return a + (spr ? (Number(b.qty || 0) * spr) : 0);
      }, 0);
      const footRowSell = sheetSelling.addRow([]);
      sheetSelling.mergeCells(`A${footRowSell.number}:${excelColLetter(lastColSell-1)}${footRowSell.number}`);
      const labelCellS = footRowSell.getCell(1);
      labelCellS.value = "Grand Total";
      labelCellS.font = { name: 'Arial', bold: true };
      labelCellS.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFEF3D6" } };
      labelCellS.alignment = { horizontal: "center", vertical: "middle" };
      labelCellS.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
      const totalCellS = footRowSell.getCell(lastColSell);
      totalCellS.value = sumSelling;
      totalCellS.numFmt = "#,##0";
      totalCellS.font = { name: 'Arial', bold: true };
      totalCellS.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFEF3D6" } };
      totalCellS.alignment = { horizontal: "right", vertical: "middle" };
      totalCellS.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };

      // SHEET: COGS
      const sheetCogs = workbook.addWorksheet("COGS");
      sheetCogs.columns = [
        { key: "no", width: 6 }, { key: "name", width: 40 }, { key: "qty", width: 10 },
        { key: "unit", width: 12 }, { key: "price", width: 18 }, { key: "totalCogs", width: 18 },
        { key: "margin", width: 12 }
      ];
      sheetCogs.insertRow(1, [currentProjectName ? `BOQ - ${currentProjectName}` : 'BOQ']);
      sheetCogs.insertRow(2, []);
      const lastColCogs = sheetCogs.columns.length;
      sheetCogs.mergeCells(`A1:${excelColLetter(lastColCogs)}1`);
      const tCellC = sheetCogs.getRow(1).getCell(1);
      tCellC.font = { name: 'Arial', bold: true };
      tCellC.alignment = { horizontal: 'left', vertical: 'middle' };

      const headerCogs = ["No","Nama Item","Qty","Unit","Harga COGS","Total COGS","Margin (%)"];
      sheetCogs.insertRow(3, headerCogs);
      const headerRowCogs = sheetCogs.getRow(3);
      headerRowCogs.eachCell((cell) => {
        cell.font = { name: 'Arial', bold: true, color: { argb: "FFFFFFFF" } };
        cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF1F4E78" } };
        cell.alignment = { horizontal: "center", vertical: "middle" };
        cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
      });

      const groupedC = {};
      tableData.forEach(r => { const cat = sanitize(r.category || "Uncategorized"); if (!groupedC[cat]) groupedC[cat] = []; groupedC[cat].push(r); });
      normalizeCategoryOrder();
      let noC = 1;
      categoryOrder.forEach(cat => {
        const secRow = sheetCogs.addRow([cat]);
        sheetCogs.mergeCells(`A${secRow.number}:${excelColLetter(lastColCogs)}${secRow.number}`);
        for (let i=1;i<=lastColCogs;i++){
          const cell = secRow.getCell(i);
          cell.font = { name: 'Arial', bold: true };
          cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFEEEEEE" } };
          cell.alignment = { horizontal: "left", vertical: "middle" };
          cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
        }
        (groupedC[cat]||[]).forEach(r => {
          const totalCogs = (r.price != null && r.price !== "" && r.qty != null && r.qty !== "") ? Number(r.price) * Number(r.qty) : "";
          const rowObj = [ noC++, r.name, r.qty, r.unit, (r.price!=="" && r.price!=null) ? Number(r.price) : "", (totalCogs !== "" ? totalCogs : ""), (r.margin!==undefined && r.margin!=null)? r.margin : "" ];
          const dr = sheetCogs.addRow(rowObj);
          dr.eachCell((cell, colNum) => {
            cell.font = { name: 'Arial' };
            cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
            if (colNum >= 5 && colNum <= 6) { cell.numFmt = "#,##0"; cell.alignment = { horizontal:"right", vertical:"middle" }; }
            else if (colNum === 2) { cell.alignment = { horizontal:"left", vertical:"middle", wrapText:true }; }
            else { cell.alignment = { horizontal:"center", vertical:"middle" }; }
          });
        });
      });

      const sumCogs = tableData.reduce((a,b) => a + (Number(b.price || 0) * Number(b.qty || 0)), 0);
      const footRowCogs = sheetCogs.addRow([]);
      sheetCogs.mergeCells(`A${footRowCogs.number}:${excelColLetter(lastColCogs-1)}${footRowCogs.number}`);
      const labelCellC = footRowCogs.getCell(1);
      labelCellC.value = "Grand Total COGS";
      labelCellC.font = { name: 'Arial', bold: true };
      labelCellC.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFEF3D6" } };
      labelCellC.alignment = { horizontal: "center", vertical: "middle" };
      labelCellC.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
      const totalCellC = footRowCogs.getCell(lastColCogs);
      totalCellC.value = sumCogs;
      totalCellC.numFmt = "#,##0";
      totalCellC.font = { name: 'Arial', bold: true };
      totalCellC.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFEF3D6" } };
      totalCellC.alignment = { horizontal: "right", vertical: "middle" };
      totalCellC.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };

      // SHEET: Calculation
      const sheetCalc = workbook.addWorksheet("Calculation");
      sheetCalc.columns = [
        { key: "totalCogs", width: 18 }, { key: "totalSelling", width: 18 },
        { key: "commission", width: 18 }, { key: "grossProfit", width: 18 }, { key: "totalMargin", width: 18 }
      ];
      sheetCalc.insertRow(1, [currentProjectName ? `BOQ - ${currentProjectName}` : 'BOQ']);
      sheetCalc.insertRow(2, []);
      const lastColCalc = sheetCalc.columns.length;
      sheetCalc.mergeCells(`A1:${excelColLetter(lastColCalc)}1`);
      const tCellCalc = sheetCalc.getRow(1).getCell(1);
      tCellCalc.font = { name: 'Arial', bold: true };
      tCellCalc.alignment = { horizontal: 'left', vertical: 'middle' };

      const headerCalc = ["Total COGS","Total Selling","Commission","Gross Profit","Total Margin"];
      sheetCalc.insertRow(3, headerCalc);
      const headerRowCalc = sheetCalc.getRow(3);
      headerRowCalc.eachCell((cell) => {
        cell.font = { name: 'Arial', bold: true, color: { argb: "FFFFFFFF" } };
        cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF1F4E78" } };
        cell.alignment = { horizontal: "center", vertical: "middle" };
        cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
      });

      const totals = computeTotals();
      const totalCogsVal = Number(totals.totalCogs || 0);
      const totalSellingVal = Number(totals.totalSelling || 0);
      const commissionVal = Number(currentCommission || 0);
      const grossProfitVal = totalSellingVal - totalCogsVal - commissionVal;
      const totalMarginPercent = (totalSellingVal === 0) ? 0 : (grossProfitVal / totalSellingVal * 100);

      const dataRowCalc = sheetCalc.addRow([ totalCogsVal, totalSellingVal, commissionVal, grossProfitVal, (isFinite(totalMarginPercent) ? totalMarginPercent.toFixed(2) + '%' : '0.00%') ]);
      dataRowCalc.eachCell((cell, colNum) => {
        cell.font = { name: 'Arial' };
        cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
        if (colNum <= 4) { cell.numFmt = "#,##0"; cell.alignment = { horizontal: "right", vertical: "middle" }; }
        else { cell.alignment = { horizontal: "center", vertical: "middle" }; }
      });

      const footCalc = sheetCalc.addRow([]);
      sheetCalc.mergeCells(`A${footCalc.number}:${excelColLetter(lastColCalc)}${footCalc.number}`);
      const labelCellCalc = footCalc.getCell(1);
      labelCellCalc.value = "Calculation Summary";
      labelCellCalc.font = { name: 'Arial', bold: true };
      labelCellCalc.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFEF3D6" } };
      labelCellCalc.alignment = { horizontal: "center", vertical: "middle" };
      labelCellCalc.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };

      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function exportPDF() {
      if (!tableData.length && activeTab !== 'calculation') { showAlert('Tidak ada data untuk diekspor.'); return; }
      let filenameSuffix = ''; if (activeTab === 'cogs') filenameSuffix = ' (COGS)'; else if (activeTab === 'selling') filenameSuffix = ' (Selling)'; else if (activeTab === 'calculation') filenameSuffix = ' (Calculation)';
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      const title = currentProjectName ? `BOQ - ${currentProjectName}` : 'BOQ';
      doc.text(title, 14, 15);

      const grouped = {}; tableData.forEach(r => { const cat = sanitize(r.category || 'Uncategorized'); if (!grouped[cat]) grouped[cat] = []; grouped[cat].push(r); });
      normalizeCategoryOrder();
      const body = []; let rowNoGlobal = 1;

      if (activeTab === 'cogs') {
        categoryOrder.forEach(cat => {
          body.push([{ content: cat, colSpan: 7, styles: { fillColor: [238,238,238], fontStyle: "bold", halign: "left", valign: "middle" } }]);
          (grouped[cat]||[]).forEach(r => {
            const totalCogs = (r.price != null && r.price !== "" && r.qty != null && r.qty !== "") ? Number(r.price) * Number(r.qty) : "";
            body.push([ rowNoGlobal++, r.name, r.qty, r.unit,
              { content: r.price != null && r.price !== "" ? Number(r.price).toLocaleString('id-ID') : "", styles: { halign: 'right', valign: 'middle' } },
              { content: totalCogs !== "" ? Number(totalCogs).toLocaleString('id-ID') : "", styles: { halign: 'right', valign: 'middle' } },
              { content: r.margin != null && r.margin !== "" ? Number(r.margin).toFixed(2) : "", styles: { halign: 'right', valign: 'middle' } }
            ]);
          });
        });
        const grandCogs = tableData.reduce((a,b) => a + (Number(b.price || 0) * Number(b.qty || 0)), 0);
        body.push([{ content: "Grand Total COGS", colSpan: 6, styles: { fontStyle: "bold", halign: "center", valign: "middle", fillColor: [254,243,214] } }, { content: grandCogs.toLocaleString('id-ID'), styles: { fontStyle: "bold", halign: "right", valign: "middle", fillColor: [254,243,214] } }]);
        const head = ["No","Nama Item","Qty","Unit","Harga COGS","Total COGS","Margin (%)"];
        doc.autoTable({ head: [head], body, startY: 22, theme: 'grid', headStyles: { fillColor: [31,78,120], textColor: [255,255,255], halign:'center', valign:'middle' }, columnStyles: { 0:{halign:'center'}, 2:{halign:'center'}, 3:{halign:'center'} }, styles: { fontSize: 10, cellPadding:3 } });
      }
      else if (activeTab === 'selling') {
        categoryOrder.forEach(cat => {
          body.push([{ content: cat, colSpan: 6, styles: { fillColor: [238,238,238], fontStyle: "bold", halign: "left", valign: "middle" } }]);
          (grouped[cat]||[]).forEach(r => {
            let spRaw = null;
            if (r.sellingPrice != null && r.sellingPrice !== "") spRaw = Number(r.sellingPrice);
            else if (r.price != null && r.price !== "") spRaw = calcSellingPrice(Number(r.price), r.margin);
            const spRounded = spRaw != null ? roundUpToThousand(spRaw) : "";
            const totalSp = (spRounded !== "") ? Number(r.qty || 0) * spRounded : "";
            body.push([ rowNoGlobal++, r.name, r.qty, r.unit,
              { content: spRounded !== "" ? Number(spRounded).toLocaleString('id-ID') : "", styles: { halign: 'right', valign: 'middle' } },
              { content: totalSp !== "" ? Number(totalSp).toLocaleString('id-ID') : "", styles: { halign: 'right', valign: 'middle' } }
            ]);
          });
        });
        const grandSelling = tableData.reduce((a,b) => {
          let sp = null;
          if (b.sellingPrice != null && b.sellingPrice !== "") sp = Number(b.sellingPrice);
          else if (b.price != null && b.price !== "") sp = calcSellingPrice(Number(b.price), b.margin);
          const spr = sp != null ? roundUpToThousand(sp) : 0;
          return a + (spr ? (Number(b.qty || 0) * spr) : 0);
        }, 0);
        body.push([{ content: "Grand Total", colSpan: 5, styles: { fontStyle:"bold", halign:"center", valign:"middle", fillColor:[254,243,214] } }, { content: grandSelling.toLocaleString('id-ID'), styles: { fontStyle:"bold", halign:"right", valign:"middle", fillColor:[254,243,214] } }]);
        const head = ["No","Nama Item","Qty","Unit","Harga Satuan","Total"];
        doc.autoTable({ head: [head], body, startY: 22, theme: 'grid', headStyles: { fillColor: [31,78,120], textColor: [255,255,255], halign:'center', valign:'middle' }, columnStyles: { 0:{halign:'center'}, 2:{halign:'center'}, 3:{halign:'center'} }, styles: { fontSize:10, cellPadding:3 } });
      }
      else if (activeTab === 'calculation') {
        const totals = computeTotals();
        const totalCogs = Number(totals.totalCogs || 0);
        const totalSelling = Number(totals.totalSelling || 0);
        const commission = Number(currentCommission || 0);
        const grossProfit = totalSelling - totalCogs - commission;
        const totalMargin = (totalSelling === 0) ? 0 : (grossProfit / totalSelling);
        const head = ["Total COGS","Total Selling","Commission","Gross Profit","Total Margin"];
        const row = [
          { content: Number(totalCogs).toLocaleString('id-ID'), styles: { halign:'right', valign:'middle' } },
          { content: Number(totalSelling).toLocaleString('id-ID'), styles: { halign:'right', valign:'middle' } },
          { content: Number(commission).toLocaleString('id-ID'), styles: { halign:'right', valign:'middle' } },
          { content: Number(grossProfit).toLocaleString('id-ID'), styles: { halign:'right', valign:'middle' } },
          { content: (isFinite(totalMargin) ? (totalMargin*100).toFixed(2) + '%' : '0.00%'), styles: { halign:'center', valign:'middle' } }
        ];
        doc.autoTable({ head: [head], body: [row], startY: 22, theme: 'grid', headStyles: { fillColor: [31,78,120], textColor: [255,255,255], halign:'center', valign:'middle' }, styles: { fontSize:10, cellPadding:3 } });
      }
      const filename = getSafeFileName(currentProjectName) + (filenameSuffix ? filenameSuffix : '') + ".pdf";
      doc.save(filename);
    }

    // MANAGE ITEMS & PROJECTS
    manageBtn.addEventListener('click', () => {
      manageItemSearch.value = '';
      populateManageItems();
      manageModal.style.display = 'block';
      manageModal.setAttribute('aria-hidden','false');
      manageItemSearch.focus();
    });
    modalClose.addEventListener('click', () => { manageModal.style.display = 'none'; manageModal.setAttribute('aria-hidden','true'); });
    projectsClose.addEventListener('click', () => { projectsModal.style.display = 'none'; projectsModal.setAttribute('aria-hidden','true'); });
    manageProjectsBtn.addEventListener('click', () => {
      manageProjectSearch.value = '';
      populateManageProjects();
      projectsModal.style.display = 'block';
      projectsModal.setAttribute('aria-hidden','false');
      manageProjectSearch.focus();
    });

    function populateManageItems() {
      manageItemList.innerHTML = '';
      const q = String(manageItemSearch.value || '').trim().toLowerCase();
      const map = {};
      items.forEach(it => { if (!it || !it.name) return; const key = it.name.trim(); if (!map[key] || (it.updatedAt && map[key].updatedAt < it.updatedAt)) map[key] = it; });
      const arr = Object.values(map).slice().sort((a,b) => (a.name||'').toLowerCase().localeCompare((b.name||'').toLowerCase()));
      const filtered = arr.filter(it => !q || (it.name||'').toLowerCase().includes(q));
      filtered.forEach((it) => {
        const li = document.createElement('li');
        const span = document.createElement('span'); span.textContent = it.name;
        const renameBtn = document.createElement('button'); renameBtn.textContent = 'Rename'; renameBtn.className = 'btn ghost';
        renameBtn.addEventListener('click', () => {
          const newName = sanitize(prompt('Ubah nama item:', it.name) || '');
          if (!newName) return;
          const oldKey = normalizeKey(it.name);
          items.forEach(x => { if (normalizeKey(x.name) === oldKey) x.name = newName; });
          localStorage.setItem('boq_items', JSON.stringify(items));
          updateDatalist(); populateManageItems();
        });
        const delBtn = document.createElement('button'); delBtn.textContent = 'Hapus'; delBtn.className = 'btn secondary';
        delBtn.addEventListener('click', () => {
          if (!confirm(`Hapus item "${it.name}"?`)) return;
          const key = normalizeKey(it.name);
          items = items.filter(x => normalizeKey(x.name) !== key);
          localStorage.setItem('boq_items', JSON.stringify(items));
          updateDatalist(); populateManageItems();
        });
        li.appendChild(span); li.appendChild(renameBtn); li.appendChild(delBtn);
        manageItemList.appendChild(li);
      });
    }

    function populateManageProjects() {
      manageProjectList.innerHTML = '';
      const q = String(manageProjectSearch.value || '').trim().toLowerCase();
      const projects = loadProjectsObj();
      const names = Object.keys(projects || {}).slice().sort((a,b) => (a||'').toLowerCase().localeCompare((b||'').toLowerCase()));
      const filtered = names.filter(n => !q || (n||'').toLowerCase().includes(q));
      filtered.forEach(name => {
        const li = document.createElement('li');
        const span = document.createElement('span'); span.textContent = name;
        const delBtn = document.createElement('button'); delBtn.textContent = 'Hapus'; delBtn.className = 'btn secondary';
        delBtn.addEventListener('click', () => { if (!confirm(`Hapus project "${name}"?`)) return; delete projects[name]; saveProjectsObj(projects); populateManageProjects(); updateProjectList(); updateFooterLastSaved(); });
        const renameBtn = document.createElement('button'); renameBtn.textContent = 'Rename'; renameBtn.className = 'btn ghost';
        renameBtn.addEventListener('click', () => {
          const newName = sanitize(prompt('Ubah nama project:', name) || '');
          if (!newName) return;
          if (projects[newName]) { showAlert('Nama project sudah ada.'); return; }
          projects[newName] = projects[name];
          projects[newName].lastSaved = Date.now(); // rename dianggap update
          delete projects[name];
          saveProjectsObj(projects);
          if (currentProjectName === name) { currentProjectName = newName; localStorage.setItem('boq_current_name', currentProjectName); updateNavProject(); updateFooterLastSaved(); }
          populateManageProjects(); updateProjectList();
        });
        li.appendChild(span); li.appendChild(renameBtn); li.appendChild(delBtn);
        manageProjectList.appendChild(li);
      });
    }

    window.addEventListener('click', (e) => {
      if (e.target === manageModal) { manageModal.style.display = 'none'; manageModal.setAttribute('aria-hidden','true'); }
      if (e.target === projectsModal) { projectsModal.style.display = 'none'; projectsModal.setAttribute('aria-hidden','true'); }
    });

    function updateProjectList() {
      const projects = loadProjectsObj();
      projectList.innerHTML = '';
      const keys = Object.keys(projects || {}).slice().sort((a,b) => (a||'').toLowerCase().localeCompare((b||'').toLowerCase()));
      keys.forEach(k => { const opt = document.createElement('option'); opt.value = k; projectList.appendChild(opt); });
    }

    manageItemSearch.addEventListener('input', populateManageItems);
    manageProjectSearch.addEventListener('input', populateManageProjects);

    saveProjectBtn.addEventListener('click', saveProject);
    loadProjectBtn.addEventListener('click', () => loadProject());
    newProjectBtn.addEventListener('click', () => newProject());

    function saveProject() {
      if (!tableData.length) { showAlert('Tidak ada data untuk disimpan.'); return; }
      let name = prompt('Masukkan nama project:', currentProjectName || '');
      if (!name) return;
      name = sanitize(name);
      const projects = loadProjectsObj();
      if (projects[name] && !confirm('Nama project sudah ada. Timpa?')) return;
      projects[name] = {
        data: tableData,
        commission: Number(currentCommission || 0),
        categoryOrder: categoryOrder.slice(),
        lastSaved: Date.now()
      };
      saveProjectsObj(projects);
      currentProjectName = name; localStorage.setItem('boq_current_name', currentProjectName);
      updateProjectList(); updateNavProject(); updateFooterLastSaved();
      showAlert(`Project "${name}" berhasil disimpan.`);
    }

    function loadProject() {
      const name = sanitize(projectSearch.value || '');
      if (!name) { showAlert('Masukkan nama project terlebih dahulu.'); return; }
      const projects = loadProjectsObj();
      if (!projects[name]) { showAlert('Project tidak ditemukan.'); return; }
      const stored = projects[name];
      if (Array.isArray(stored)) { tableData = stored; currentCommission = 0; categoryOrder = []; }
      else if (stored && typeof stored === 'object') {
        tableData = stored.data || [];
        currentCommission = Number(stored.commission || 0);
        categoryOrder = (stored.categoryOrder && Array.isArray(stored.categoryOrder)) ? stored.categoryOrder.slice() : [];
      } else { tableData = []; currentCommission = 0; categoryOrder = []; }
      form.reset(); sellingInputManuallyEdited = false; setEditingMode(null); selectedIndex = null;
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      localStorage.setItem('boq_category_order', JSON.stringify(categoryOrder));
      currentProjectName = name; localStorage.setItem('boq_current_name', currentProjectName);
      updateNavProject(); updateProjectList(); renderAll(); projectSearch.value = '';
      updateFooterLastSaved();
      showAlert(`Project "${name}" berhasil dimuat.`);
      updateEditButton();
    }

    function newProject() {
      if (!confirm('Buat project baru? Semua data saat ini akan dihapus.')) return;
      tableData = []; selectedIndex = null; setEditingMode(null); currentProjectName = ''; currentCommission = 0;
      categoryOrder = [];
      form.reset(); sellingInputManuallyEdited = false;
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      localStorage.setItem('boq_category_order', JSON.stringify(categoryOrder));
      localStorage.removeItem('boq_current_name');
      updateNavProject(); renderAll(); updateEditButton();
      updateFooterLastSaved(); // no project => 'â€”'
      showAlert('Project baru siap diisi.');
    }

    renameProjectBtn.addEventListener('click', () => {
      if (!currentProjectName) { showAlert('Tidak ada project aktif. Simpan project dulu agar bisa rename.'); return; }
      const newName = sanitize(prompt('Ubah nama project:', currentProjectName) || '');
      if (!newName) return;
      const projects = loadProjectsObj();
      if (projects[newName] && newName !== currentProjectName && !confirm('Nama project sudah ada. Timpa?')) return;
      if (projects[currentProjectName]) delete projects[currentProjectName];
      projects[newName] = {
        data: tableData,
        commission: Number(currentCommission || 0),
        categoryOrder: categoryOrder.slice(),
        lastSaved: Date.now() // rename dianggap update
      };
      saveProjectsObj(projects);
      currentProjectName = newName; localStorage.setItem('boq_current_name', currentProjectName); updateProjectList(); updateNavProject(); updateFooterLastSaved();
      showAlert('Nama project diubah.');
    });

    downloadJSONBtn.addEventListener('click', () => {
      const projects = loadProjectsObj();
      const payload = { exportedAt: new Date().toISOString(), projects: projects, items: items || [], working: tableData || [], categoryOrder: categoryOrder || [], currentProjectName: currentProjectName || null, unsavedCommission: Number(currentCommission || 0) };
      const ts = new Date(); const pad = n => String(n).toString().padStart(2,'0');
      const filename = `boq_backup_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    });

    restoreJSONBtn.addEventListener('click', () => { restoreInput.value = ''; restoreInput.click(); });
    restoreInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        let parsed = null;
        try { parsed = JSON.parse(String(e.target.result)); } catch (err) { showAlert('File tidak valid: bukan JSON.'); return; }
        let restoreObj = { projects: {}, items: [], working: [], currentProjectName: '', unsavedCommission: 0, categoryOrder: [] };
        if (parsed && typeof parsed === 'object') {
          if (parsed.projects && typeof parsed.projects === 'object') {
            restoreObj.projects = parsed.projects || {};
            restoreObj.items = Array.isArray(parsed.items) ? parsed.items : (parsed.items || []);
            restoreObj.working = Array.isArray(parsed.working) ? parsed.working : (parsed.working || []);
            restoreObj.currentProjectName = parsed.currentProjectName || (parsed.project || '') || '';
            restoreObj.unsavedCommission = Number(parsed.unsavedCommission || parsed.commission || 0);
            restoreObj.categoryOrder = Array.isArray(parsed.categoryOrder) ? parsed.categoryOrder : [];
          } else if (parsed.project && parsed.data) {
            const projName = sanitize(parsed.project) || ('Imported Project ' + new Date().toISOString());
            restoreObj.projects = loadProjectsObj();
            restoreObj.projects[projName] = { data: Array.isArray(parsed.data) ? parsed.data : [], commission: Number(parsed.commission || 0), categoryOrder: Array.isArray(parsed.categoryOrder) ? parsed.categoryOrder : [], lastSaved: Date.now() };
            restoreObj.items = items || [];
            restoreObj.working = restoreObj.projects[projName].data;
            restoreObj.currentProjectName = projName;
            restoreObj.unsavedCommission = Number(parsed.commission || 0);
            restoreObj.categoryOrder = restoreObj.projects[projName].categoryOrder || [];
          } else {
            restoreObj.projects = parsed.projects || parsed.projectList || {};
            restoreObj.items = parsed.items || parsed.boq_items || [];
            restoreObj.working = parsed.working || parsed.boq_working || [];
            restoreObj.currentProjectName = parsed.currentProjectName || parsed.current || '';
            restoreObj.unsavedCommission = Number(parsed.unsavedCommission || parsed.commission || 0);
            restoreObj.categoryOrder = Array.isArray(parsed.categoryOrder) ? parsed.categoryOrder : [];
          }
        }
        if (!confirm('Restore akan menimpa semua data lokal (projects, items, working, category order, current project). Lanjutkan?')) { return; }
        try {
          saveProjectsObj(restoreObj.projects || {});
          localStorage.setItem('boq_items', JSON.stringify(restoreObj.items || []));
          localStorage.setItem('boq_working', JSON.stringify(restoreObj.working || []));
          localStorage.setItem('boq_category_order', JSON.stringify(restoreObj.categoryOrder || []));
          if (restoreObj.currentProjectName) { localStorage.setItem('boq_current_name', restoreObj.currentProjectName); currentProjectName = restoreObj.currentProjectName; } else { localStorage.removeItem('boq_current_name'); currentProjectName = ''; }
          if (restoreObj.unsavedCommission && Number(restoreObj.unsavedCommission) !== 0) localStorage.setItem(UNSAVED_COMM_KEY, String(Number(restoreObj.unsavedCommission))); else localStorage.removeItem(UNSAVED_COMM_KEY);
          items = JSON.parse(localStorage.getItem('boq_items')) || [];
          tableData = JSON.parse(localStorage.getItem('boq_working')) || [];
          categoryOrder = JSON.parse(localStorage.getItem('boq_category_order')) || [];
          loadCommissionForCurrentProject();
          updateNavProject(); updateProjectList(); updateDatalist(); renderAll();
          updateFooterLastSaved();
          showAlert('Restore berhasil. Data lokal telah diperbarui.');
        } catch (err) { console.error(err); showAlert('Terjadi kesalahan saat menyimpan data ke localStorage.');
        }
      };
      reader.readAsText(f);
    });

    // INIT
    function updateEditButton(){ editBtn.textContent = (editingIndex === null) ? 'Edit' : 'Cancel Edit'; }
    updateNavProject();
    (function init(){
      updateProjectList();
      updateDatalist();
      loadCommissionForCurrentProject();
      normalizeCategoryOrder();
      updateReorderButton();
      renderAll();
      switchTo('cogs');
      updateEditButton();
      updateFooterLastSaved();
    })();
  </script>
</body>
</html>
