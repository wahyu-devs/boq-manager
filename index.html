<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>BOQ Manager — COGS & Selling & Calculation (Tabs)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --nav-bg: #0b0b0b;
      --nav-txt: #fff;
      --container-pad: 20px;
      --card: #fff;
      --muted: #777;
      --accent: #1976d2;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      color: #111
    }

    .navbar-wrapper {
      background: var(--nav-bg);
      width: 100%
    }

    .navbar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 0
    }

    .brand {
      font-weight: 700;
      color: var(--nav-txt)
    }

    .project-name {
      opacity: .9;
      color: var(--nav-txt);
      font-weight: 400
    }

    .nav-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px
    }

    .btn.secondary {
      background: #eee;
      color: #111;
      border: 1px solid #ccc
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, .3);
      color: var(--nav-txt)
    }

    .container {
      padding: var(--container-pad);
      max-width: 1200px;
      margin: 0 auto
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: flex-end;
      border-bottom: 1px solid #e6e6e6;
      padding-bottom: 6px;
    }

    .tab-btn {
      background: transparent;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      position: relative;
      transition: color .12s ease, background .12s ease;
      margin: 0;
    }

    .tab-btn:focus {
      outline: none;
    }

    .tab-btn.active {
      color: var(--accent);
      font-weight: 600;
    }

    .tab-btn.active::after {
      content: "";
      position: absolute;
      left: 18%;
      right: 18%;
      bottom: -8px;
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      box-shadow: 0 1px 4px rgba(25, 118, 210, 0.25);
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
      align-items: center
    }

    input[type="text"],
    input[type="number"],
    input[list] {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d6d6d6;
      font-size: 14px;
      min-height: 36px;
      width: 130px;
    }

    input[type="number"] {
      width: 130px
    }

    #itemName {
      flex: 1
    }

    #projectSearch {
      width: 220px
    }

    button[type="submit"] {
      min-width: 140px;
      align-self: center
    }

    .table-wrap {
      overflow: auto;
      background: var(--card);
      border-radius: 6px;
      padding: 8px;
      border: 1px solid #e6e6e6
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent
    }

    th,
    td {
      border: 1px solid #e9e9e9;
      padding: 8px;
      text-align: center;
      font-size: 13px
    }

    th {
      background: #fbfbfb;
      font-weight: 700
    }

    td.left {
      text-align: left
    }

    tfoot .total {
      background: #fff5e6;
      font-weight: 700
    }

    #cogsTable tfoot td.total.label,
    #sellingTable tfoot td.total.label {
      text-align: center;
    }

    #cogsTable tfoot td.total.value,
    #sellingTable tfoot td.total.value {
      text-align: right;
    }

    tr.section-row td {
      background: #f1f1f1;
      font-weight: 700;
      text-align: left;
      padding-left: 12px;
      border-top: 2px solid #e0e0e0
    }

    tr.selected {
      background: #e8f7fb
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    .actions label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted)
    }

    .small-note {
      font-size: 12px;
      color: var(--muted)
    }

    .hidden {
      display: none
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: #fff;
      margin: 6% auto;
      padding: 16px;
      border-radius: 8px;
      width: 90%;
      max-width: 520px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      border: 1px solid #ddd;
    }

    .modal-header {
      font-weight: 700;
      margin-bottom: 8px
    }

    .modal-list {
      max-height: 300px;
      overflow: auto;
      margin-bottom: 12px;
      padding: 0;
      list-style: none
    }

    .modal-list li {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 4px;
      border-bottom: 1px solid #eee
    }

    .modal-list li span {
      flex: 1
    }

    .modal-close {
      float: right;
      cursor: pointer;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      background: #eee;
      border: 1px solid #ddd
    }

    .calc-summary thead th {
      text-align: center;
    }

    .calc-summary tbody td.value {
      font-weight: 400;
      text-align: center;
      min-width: 140px;
    }

    .commission-input {
      width: 120px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }

    @media (max-width:720px) {
      .nav-actions {
        display: none
      }

      .container {
        padding: 12px
      }

      input[type="number"],
      #projectSearch {
        width: 100%
      }

      form {
        flex-direction: column;
        align-items: stretch
      }

      .actions {
        flex-direction: column;
        align-items: stretch
      }

      button[type="submit"] {
        align-self: stretch
      }

      .calc-summary tbody td.value {
        min-width: 100px;
      }

      .commission-input {
        width: 100px;
      }
    }
  </style>
</head>

<body>
  <div class="navbar-wrapper">
    <div class="container navbar">
      <div class="brand">BOQ Manager <span class="project-name" id="navProject">(no project)</span></div>
      <div class="nav-actions">
        <button class="btn ghost" id="renameProjectBtn" title="Rename project">Rename</button>
        <button class="btn ghost" id="manageBtn">Manage Items & Projects</button>
        <button class="btn secondary" id="downloadJSON" title="Backup semua data (projects, items, working, commission)">Backup Data</button>
        <button class="btn secondary" id="restoreJSON" title="Restore dari file backup JSON">Restore Data</button>
        <input type="file" id="restoreInput" accept=".json,application/json" style="display:none" />
      </div>
    </div>
  </div>

  <div class="container">
    <div class="tabs" role="tablist" aria-label="Primary tabs">
      <button class="tab-btn active" id="tabCogsBtn" role="tab" aria-selected="true">COGS</button>
      <button class="tab-btn" id="tabSellingBtn" role="tab" aria-selected="false">Selling</button>
      <button class="tab-btn" id="tabCalcBtn" role="tab" aria-selected="false">Calculation</button>
    </div>

    <form id="boqForm" autocomplete="off">
      <input type="text" id="itemName" placeholder="Nama Item" list="itemList" required />
      <datalist id="itemList"></datalist>
      <input type="number" id="qty" placeholder="Qty" />
      <input type="text" id="unit" placeholder="Unit" />
      <input type="text" id="price" placeholder="Harga COGS" />
      <input type="number" id="margin" placeholder="Margin (%)" min="0" max="999.99" step="0.01" />
      <input type="text" id="sellingInput" placeholder="Harga Jual" />
      <input type="text" id="category" placeholder="Kategori" required />
      <button type="submit" class="btn">Tambah / Update</button>
    </form>

    <div id="tabCogs" class="tab-panel">
      <div class="table-wrap">
        <table id="cogsTable" aria-label="COGS table">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Item</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Harga COGS</th>
              <th>Total COGS</th>
              <th>Margin (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="total label">Grand Total COGS</td>
              <td class="total value" id="grandCogs">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="tabSelling" class="tab-panel hidden">
      <div class="table-wrap">
        <table id="sellingTable" aria-label="Selling table">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Item</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Harga Satuan</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="total label">Grand Total</td>
              <td class="total value" id="grandSelling">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="tabCalc" class="tab-panel hidden">
      <div class="table-wrap">
        <table id="calcSummary" class="calc-summary" aria-label="Calculation summary">
          <thead>
            <tr>
              <th>Total COGS</th>
              <th>Total Selling</th>
              <th>Commission</th>
              <th>Gross Profit</th>
              <th>Total Margin</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="calcTotalCogs" class="value">0</td>
              <td id="calcTotalSelling" class="value">0</td>
              <td id="calcCommissionCell" class="value"><input id="commissionCellInput" class="commission-input" type="text" placeholder="0" /></td>
              <td id="calcGrossProfit" class="value">0</td>
              <td id="calcTotalMargin" class="value">0.00%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="actions">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn secondary" type="button" onclick="editRow()">Edit</button>
        <button class="btn secondary" type="button" onclick="deleteRow()">Hapus</button>
        <button class="btn" type="button" onclick="exportExcel()">Export Excel</button>
        <button class="btn" type="button" onclick="exportPDF()">Export PDF</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input list="projectList" id="projectSearch" placeholder="Cari project..." />
        <datalist id="projectList"></datalist>
        <button class="btn secondary" type="button" onclick="loadProject()">Muat Project</button>
        <button class="btn secondary" type="button" onclick="saveProject()">Simpan Project</button>
        <button class="btn" type="button" onclick="newProject()">Buat Project Baru</button>
      </div>
    </div>
  </div>

  <!-- Modal Management -->
  <div id="manageModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" id="modalClose">&times;</button>
      <div class="modal-header">Manage Items</div>
      <ul id="manageItemList" class="modal-list"></ul>
      <div style="text-align:right"><button class="btn secondary" id="manageProjectsBtn">Manage Projects</button></div>
    </div>
  </div>

  <!-- Modal Projects -->
  <div id="projectsModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" id="projectsClose">&times;</button>
      <div class="modal-header">Manage Projects</div>
      <ul id="manageProjectList" class="modal-list"></ul>
    </div>
  </div>

  <script>
    // ===== STATE & HELPERS =====
    const tabCogsBtn = document.getElementById('tabCogsBtn');
    const tabSellingBtn = document.getElementById('tabSellingBtn');
    const tabCalcBtn = document.getElementById('tabCalcBtn');
    const tabCogs = document.getElementById('tabCogs');
    const tabSelling = document.getElementById('tabSelling');
    const tabCalc = document.getElementById('tabCalc');
    let activeTab = 'cogs';

    function switchTo(tab) {
      activeTab = tab;
      tabCogs.classList.add('hidden');
      tabSelling.classList.add('hidden');
      tabCalc.classList.add('hidden');
      [tabCogsBtn, tabSellingBtn, tabCalcBtn].forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
      });
      if (tab === 'cogs') {
        tabCogs.classList.remove('hidden');
        tabCogsBtn.classList.add('active');
        tabCogsBtn.setAttribute('aria-selected', 'true');
        document.getElementById('boqForm').style.display = '';
      } else if (tab === 'selling') {
        tabSelling.classList.remove('hidden');
        tabSellingBtn.classList.add('active');
        tabSellingBtn.setAttribute('aria-selected', 'true');
        document.getElementById('boqForm').style.display = 'none';
      } else if (tab === 'calculation') {
        tabCalc.classList.remove('hidden');
        tabCalcBtn.classList.add('active');
        tabCalcBtn.setAttribute('aria-selected', 'true');
        document.getElementById('boqForm').style.display = 'none';
        renderCalculation();
      }
    }
    tabCogsBtn.addEventListener('click', () => switchTo('cogs'));
    tabSellingBtn.addEventListener('click', () => switchTo('selling'));
    tabCalcBtn.addEventListener('click', () => switchTo('calculation'));
    const form = document.getElementById('boqForm');
    const itemList = document.getElementById('itemList');
    const priceInput = document.getElementById('price');
    const marginInput = document.getElementById('margin');
    const sellingInput = document.getElementById('sellingInput');
    const qtyInput = document.getElementById('qty');
    const unitInput = document.getElementById('unit');
    const categoryInput = document.getElementById('category');
    const nameInput = document.getElementById('itemName');
    const cogsTbody = document.querySelector('#cogsTable tbody');
    const sellingTbody = document.querySelector('#sellingTable tbody');
    const grandCogsEl = document.getElementById('grandCogs');
    const grandSellingEl = document.getElementById('grandSelling');
    const projectSearch = document.getElementById('projectSearch');
    const projectList = document.getElementById('projectList');
    const navProject = document.getElementById('navProject');
    const renameProjectBtn = document.getElementById('renameProjectBtn');
    const downloadJSONBtn = document.getElementById('downloadJSON');
    const restoreJSONBtn = document.getElementById('restoreJSON');
    const restoreInput = document.getElementById('restoreInput');
    const manageBtn = document.getElementById('manageBtn');
    const manageModal = document.getElementById('manageModal');
    const projectsModal = document.getElementById('projectsModal');
    const modalClose = document.getElementById('modalClose');
    const projectsClose = document.getElementById('projectsClose');
    const manageItemList = document.getElementById('manageItemList');
    const manageProjectsBtn = document.getElementById('manageProjectsBtn');
    const manageProjectList = document.getElementById('manageProjectList');
    // Calculation elements
    const calcTotalCogsEl = document.getElementById('calcTotalCogs');
    const calcTotalSellingEl = document.getElementById('calcTotalSelling');
    const commissionCellInput = document.getElementById('commissionCellInput');
    const calcGrossProfitEl = document.getElementById('calcGrossProfit');
    const calcTotalMarginEl = document.getElementById('calcTotalMargin');
    // Items now stored as array of objects:
    // { name, unit, price, sellingPrice, category, updatedAt }
    let items = JSON.parse(localStorage.getItem('boq_items')) || [];
    let tableData = JSON.parse(localStorage.getItem('boq_working')) || [];
    let selectedIndex = null;
    let currentProjectName = localStorage.getItem('boq_current_name') || "";
    const PROJECTS_KEY = 'boq_projects_v2';
    const UNSAVED_COMM_KEY = 'boq_unsaved_commission';
    let currentCommission = 0;

    function sanitize(s) {
      return String(s || '').replace(/<\/?[^>]+(>|$)/g, "").trim();
    }

    function getSafeFileName(name) {
      if (!name) return 'BOQ';
      return (`BOQ - ${name}`).replace(/[\\\/:*?"<>|]/g, '').trim();
    }

    function updateNavProject() {
      navProject.textContent = currentProjectName ? `| ${currentProjectName}` : '(no project)';
    }

    function showAlert(msg) {
      alert(msg);
    }

    function parseNumberFormatted(str) {
      if (str == null) return null;
      const raw = String(str).replace(/\./g, '').replace(/,/g, '').trim();
      return raw === '' ? null : Number(raw);
    }

    function formatThousandsInput(el) {
      el.addEventListener('input', () => {
        const raw = String(el.value).replace(/[^\d]/g, '');
        el.value = raw ? Number(raw).toLocaleString('id-ID') : '';
      });
    }
    formatThousandsInput(priceInput);
    formatThousandsInput(sellingInput);

    function updateDatalist() {
      // unique names, keep latest order by updatedAt desc
      const map = {};
      items.forEach(it => {
        if (!it || !it.name) return;
        const key = it.name.trim();
        if (!map[key] || (it.updatedAt && map[key].updatedAt < it.updatedAt)) {
          map[key] = it;
        }
      });
      itemList.innerHTML = '';
      Object.keys(map).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        itemList.appendChild(opt);
      });
    }

    function calcSellingPrice(cogs, marginPercent) {
      const m = Number(marginPercent) / 100;
      if (!isFinite(m) || m >= 1) return null;
      if (cogs === "" || cogs == null) return null;
      return Number(cogs) / (1 - m);
    }

    function roundUpToThousand(n) {
      if (n == null || !isFinite(n)) return null;
      const eps = 1e-9;
      return Math.ceil((n - eps) / 1000) * 1000;
    }
    // ---------- ITEM helpers (autofill & store) ----------
    function normalizeKey(name) {
      return String(name || '').trim().toLowerCase();
    }
    // return the latest item object by name (case-insensitive) or null
    function getItemByName(name) {
      if (!name) return null;
      const key = normalizeKey(name);
      let best = null;
      for (const it of items) {
        if (!it || !it.name) continue;
        if (normalizeKey(it.name) === key) {
          if (!best || (it.updatedAt || 0) > (best.updatedAt || 0)) best = it;
        }
      }
      return best;
    }
    // merge/update items array with provided fields (non-empty fields overwrite)
    function updateItemsWithEntry(name, unit, price, sellingPrice, category) {
      if (!name) return;
      const key = normalizeKey(name);
      let foundIndex = -1;
      for (let i = 0; i < items.length; i++) {
        if (normalizeKey(items[i].name) === key) {
          foundIndex = i;
          break;
        }
      }
      const now = Date.now();
      if (foundIndex >= 0) {
        const it = items[foundIndex];
        // Overwrite with provided non-empty values — but also allow empty strings to clear
        if (unit !== undefined) it.unit = unit;
        if (price !== undefined) it.price = price;
        if (sellingPrice !== undefined) it.sellingPrice = sellingPrice;
        if (category !== undefined) it.category = category;
        it.updatedAt = now;
        items[foundIndex] = it;
      } else {
        const newIt = {
          name: name,
          unit: unit || "",
          price: (price !== undefined && price !== null) ? price : "",
          sellingPrice: (sellingPrice !== undefined && sellingPrice !== null) ? sellingPrice : "",
          category: category || "",
          updatedAt: now
        };
        items.push(newIt);
      }
      // dedupe by normalized name keeping the latest updatedAt entry
      const map = {};
      items.forEach(it => {
        const k = normalizeKey(it.name);
        if (!map[k] || (it.updatedAt || 0) > (map[k].updatedAt || 0)) map[k] = it;
      });
      items = Object.values(map);
      localStorage.setItem('boq_items', JSON.stringify(items));
      updateDatalist();
    }
    // autofill form fields when user selects/inputs an existing item name
    function autofillFromItem(name) {
      const it = getItemByName(name);
      if (!it) return;
      // fill fields (we assume selecting name indicates want stored data)
      if (it.unit !== undefined) unitInput.value = it.unit || "";
      // price and selling: format to locale string if present
      if (it.price !== undefined && it.price !== "" && it.price !== null) {
        priceInput.value = Number(it.price).toLocaleString('id-ID');
        sellingInput.value = ''; // clear selling if COGS exists (user can override)
      } else {
        priceInput.value = '';
        if (it.sellingPrice !== undefined && it.sellingPrice !== "" && it.sellingPrice !== null) {
          sellingInput.value = Number(it.sellingPrice).toLocaleString('id-ID');
        } else {
          sellingInput.value = '';
        }
      }
      if (it.category !== undefined) categoryInput.value = it.category || "";
    }
    // listen to nameInput changes to autofill
    nameInput.addEventListener('input', (e) => {
      const v = sanitize(e.target.value);
      if (!v) return;
      // Try to autofill immediately (this triggers on typing too; that's acceptable)
      const found = getItemByName(v);
      if (found) autofillFromItem(v);
    });
    // ---------- Totals & rendering ----------
    function computeTotals() {
      const totalCogs = tableData.reduce((acc, r) => {
        const p = (r.price != null && r.price !== "") ? Number(r.price) : 0;
        const q = Number(r.qty || 0);
        return acc + (Number(p || 0) * q);
      }, 0);
      const totalSelling = tableData.reduce((acc, r) => {
        let sp = null;
        if (r.sellingPrice != null && r.sellingPrice !== "") sp = Number(r.sellingPrice);
        else if (r.price != null && r.price !== "") sp = calcSellingPrice(Number(r.price), r.margin);
        const spr = sp != null ? roundUpToThousand(sp) : 0;
        const q = Number(r.qty || 0);
        return acc + (spr ? (spr * q) : 0);
      }, 0);
      return {
        totalCogs,
        totalSelling
      };
    }

    function renderCogsTable() {
      cogsTbody.innerHTML = '';
      const grouped = {};
      tableData.forEach(r => {
        const cat = sanitize(r.category || 'Uncategorized');
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(r);
      });
      let idx = 1;
      let grand = 0;
      for (const cat of Object.keys(grouped)) {
        const trSec = document.createElement('tr');
        trSec.className = 'section-row';
        const tdSec = document.createElement('td');
        tdSec.colSpan = 7;
        tdSec.textContent = cat;
        trSec.appendChild(tdSec);
        cogsTbody.appendChild(trSec);
        grouped[cat].forEach(row => {
          const tr = document.createElement('tr');
          const tdNo = document.createElement('td');
          tdNo.textContent = idx++;
          const tdName = document.createElement('td');
          tdName.className = 'left';
          tdName.textContent = sanitize(row.name);
          const tdQty = document.createElement('td');
          tdQty.textContent = row.qty !== "" ? row.qty : "";
          const tdUnit = document.createElement('td');
          tdUnit.textContent = row.unit || "";
          const tdCogs = document.createElement('td');
          tdCogs.style.textAlign = 'right';
          const tdTotal = document.createElement('td');
          tdTotal.style.textAlign = 'right';
          const tdMargin = document.createElement('td');
          tdMargin.style.textAlign = 'right';
          const priceNum = (row.price != null && row.price !== "") ? Number(row.price) : null;
          const qtyNum = (row.qty != null && row.qty !== "") ? Number(row.qty) : null;
          const totalCogs = (priceNum != null && qtyNum != null) ? Number(priceNum) * Number(qtyNum) : null;
          tdCogs.textContent = (priceNum != null && isFinite(priceNum)) ? Number(priceNum).toLocaleString('id-ID') : "";
          tdTotal.textContent = (totalCogs != null && isFinite(totalCogs)) ? Number(totalCogs).toLocaleString('id-ID') : "";
          tdMargin.textContent = (row.margin != null && row.margin !== "") ? Number(row.margin).toFixed(2) : "";
          if (totalCogs != null && isFinite(totalCogs)) grand += Number(totalCogs);
          tr.appendChild(tdNo);
          tr.appendChild(tdName);
          tr.appendChild(tdQty);
          tr.appendChild(tdUnit);
          tr.appendChild(tdCogs);
          tr.appendChild(tdTotal);
          tr.appendChild(tdMargin);
          tr.addEventListener('click', () => {
            selectedIndex = tableData.indexOf(row);
            document.querySelectorAll('#cogsTable tbody tr, #sellingTable tbody tr').forEach(r => r.classList.remove('selected'));
            tr.classList.add('selected');
          });
          cogsTbody.appendChild(tr);
        });
      }
      grandCogsEl.textContent = grand.toLocaleString('id-ID');
    }

    function renderSellingTable() {
      sellingTbody.innerHTML = '';
      const grouped = {};
      tableData.forEach(r => {
        const cat = sanitize(r.category || 'Uncategorized');
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(r);
      });
      let idx = 1;
      let grand = 0;
      for (const cat of Object.keys(grouped)) {
        const trSec = document.createElement('tr');
        trSec.className = 'section-row';
        const tdSec = document.createElement('td');
        tdSec.colSpan = 6;
        tdSec.textContent = cat;
        trSec.appendChild(tdSec);
        sellingTbody.appendChild(trSec);
        grouped[cat].forEach(row => {
          const tr = document.createElement('tr');
          const tdNo = document.createElement('td');
          tdNo.textContent = idx++;
          const tdName = document.createElement('td');
          tdName.className = 'left';
          tdName.textContent = sanitize(row.name);
          const tdQty = document.createElement('td');
          tdQty.textContent = row.qty !== "" ? row.qty : "";
          const tdUnit = document.createElement('td');
          tdUnit.textContent = row.unit || "";
          const tdSelling = document.createElement('td');
          tdSelling.style.textAlign = 'right';
          const tdTotalSelling = document.createElement('td');
          tdTotalSelling.style.textAlign = 'right';
          let sellingPriceRaw = null;
          if (row.sellingPrice != null && row.sellingPrice !== "") sellingPriceRaw = Number(row.sellingPrice);
          else {
            const priceNum = (row.price != null && row.price !== "") ? Number(row.price) : null;
            sellingPriceRaw = (priceNum != null) ? calcSellingPrice(priceNum, row.margin) : null;
          }
          const sellingPriceRounded = sellingPriceRaw != null ? roundUpToThousand(sellingPriceRaw) : null;
          const qtyNum = (row.qty != null && row.qty !== "") ? Number(row.qty) : null;
          const totalSelling = (sellingPriceRounded != null && qtyNum != null) ? Number(sellingPriceRounded) * Number(qtyNum) : null;
          tdSelling.textContent = (sellingPriceRounded != null && isFinite(sellingPriceRounded)) ? Number(sellingPriceRounded).toLocaleString('id-ID') : "";
          tdTotalSelling.textContent = (totalSelling != null && isFinite(totalSelling)) ? Number(totalSelling).toLocaleString('id-ID') : "";
          if (totalSelling != null && isFinite(totalSelling)) grand += Number(totalSelling);
          tr.appendChild(tdNo);
          tr.appendChild(tdName);
          tr.appendChild(tdQty);
          tr.appendChild(tdUnit);
          tr.appendChild(tdSelling);
          tr.appendChild(tdTotalSelling);
          tr.addEventListener('click', () => {
            selectedIndex = tableData.indexOf(row);
            document.querySelectorAll('#cogsTable tbody tr, #sellingTable tbody tr').forEach(r => r.classList.remove('selected'));
            tr.classList.add('selected');
          });
          sellingTbody.appendChild(tr);
        });
      }
      grandSellingEl.textContent = grand.toLocaleString('id-ID');
    }
    // Projects helper
    function loadProjectsObj() {
      try {
        return JSON.parse(localStorage.getItem(PROJECTS_KEY)) || {};
      } catch (e) {
        return {};
      }
    }

    function saveProjectsObj(obj) {
      localStorage.setItem(PROJECTS_KEY, JSON.stringify(obj));
    }
    // Calculation
    function renderCalculation() {
      const totals = computeTotals();
      const totalCogs = totals.totalCogs || 0;
      const totalSelling = totals.totalSelling || 0;
      const commission = Number(currentCommission || 0);
      const grossProfit = totalSelling - totalCogs - commission;
      const totalMargin = (totalSelling === 0) ? 0 : (grossProfit / totalSelling);
      calcTotalCogsEl.textContent = Number(totalCogs || 0).toLocaleString('id-ID');
      calcTotalSellingEl.textContent = Number(totalSelling || 0).toLocaleString('id-ID');
      commissionCellInput.value = commission ? Number(commission).toLocaleString('id-ID') : '';
      calcGrossProfitEl.textContent = Number(grossProfit || 0).toLocaleString('id-ID');
      calcTotalMarginEl.textContent = (isFinite(totalMargin) ? (totalMargin * 100).toFixed(2) : '0.00') + '%';
    }
    // Commission formatting/persistence
    (function setupCommissionCell() {
      commissionCellInput.addEventListener('input', () => {
        const rawDigits = String(commissionCellInput.value).replace(/[^\d]/g, '');
        commissionCellInput.value = rawDigits ? Number(rawDigits).toLocaleString('id-ID') : '';
        const parsed = parseNumberFormatted(commissionCellInput.value) || 0;
        currentCommission = Number(parsed);
        if (currentProjectName) {
          const projects = loadProjectsObj();
          const existing = projects[currentProjectName] || {};
          projects[currentProjectName] = {
            data: tableData,
            commission: Number(currentCommission || 0)
          };
          saveProjectsObj(projects);
        } else {
          if (currentCommission === 0) localStorage.removeItem(UNSAVED_COMM_KEY);
          else localStorage.setItem(UNSAVED_COMM_KEY, String(currentCommission));
        }
        renderCalculation();
      });
    })();

    function loadCommissionForCurrentProject() {
      if (currentProjectName) {
        const projects = loadProjectsObj();
        const p = projects[currentProjectName];
        if (p && typeof p === 'object') {
          currentCommission = Number(p.commission || 0);
          return;
        }
      }
      const unsaved = parseNumberFormatted(localStorage.getItem(UNSAVED_COMM_KEY));
      currentCommission = unsaved != null ? Number(unsaved) : 0;
    }

    function renderAll() {
      renderCogsTable();
      renderSellingTable();
      renderCalculation();
    }
    // FORM SUBMIT
    form.addEventListener('submit', e => {
      e.preventDefault();
      const name = sanitize(nameInput.value);
      const category = sanitize(categoryInput.value);
      if (!name || !category) {
        showAlert('Nama item dan kategori harus diisi.');
        return;
      }
      const qtyRaw = qtyInput.value;
      const qty = qtyRaw !== "" ? Number(qtyRaw) : "";
      const unit = sanitize(unitInput.value);
      const priceRaw = priceInput.value.replace(/\./g, '').replace(/,/g, '');
      const price = priceRaw !== "" ? Number(priceRaw) : "";
      const marginRaw = marginInput.value;
      const margin = marginRaw !== "" ? Number(marginRaw) : 0;
      const sellingRawStr = sellingInput.value.replace(/\./g, '').replace(/,/g, '');
      const sellingProvided = sellingRawStr !== "" ? Number(sellingRawStr) : "";
      if (margin >= 100) {
        if (!confirm('Margin 100% atau lebih akan membuat Harga Jual tidak terdefinisi. Lanjutkan?')) return;
      }
      const totalCogs = (qty !== "" && price !== "") ? Number(qty) * Number(price) : "";
      let sellingPriceComputed = "";
      if (sellingProvided !== "") sellingPriceComputed = sellingProvided;
      else if (price !== "" && margin < 100) {
        const sp = calcSellingPrice(price, margin);
        sellingPriceComputed = (sp != null) ? sp : "";
      } else sellingPriceComputed = "";
      const sellingPriceRoundedForTotal = (sellingPriceComputed !== "" && sellingPriceComputed != null) ? roundUpToThousand(Number(sellingPriceComputed)) : "";
      const totalSelling = (qty !== "" && sellingPriceRoundedForTotal !== "" && sellingPriceRoundedForTotal != null) ? Number(qty) * Number(sellingPriceRoundedForTotal) : "";
      const newRow = {
        name,
        qty: qty !== "" ? qty : "",
        unit,
        price: price !== "" ? price : "",
        total: totalCogs !== "" ? totalCogs : "",
        margin: margin !== "" ? margin : 0,
        sellingPrice: (sellingPriceComputed !== "" && sellingPriceComputed != null) ? Number(sellingPriceComputed) : "",
        totalSellingPrice: (totalSelling !== "" && totalSelling != null) ? totalSelling : "",
        category
      };
      if (selectedIndex !== null) {
        tableData[selectedIndex] = newRow;
        selectedIndex = null;
      } else tableData.push(newRow);
      // Persist working table
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      // Update items store with the latest data for this item
      // Preference: if price provided use it; otherwise store sellingPrice if provided
      const storePrice = (price !== "" && price != null) ? Number(price) : ((sellingProvided === "" && sellingPriceComputed !== "" && sellingPriceComputed != null) ? "" : "");
      const storeSelling = (sellingProvided !== "" && sellingProvided != null) ? Number(sellingProvided) : ((sellingProvided === "" && sellingPriceComputed !== "" && sellingPriceComputed != null) ? Number(sellingPriceComputed) : "");
      // We want to store price if present, and sellingPrice if present (both allowed)
      updateItemsWithEntry(name, unit || "", (price !== "" ? Number(price) : (storePrice === "" ? "" : "")), (storeSelling !== "" ? storeSelling : (sellingPriceComputed !== "" ? Number(sellingPriceComputed) : "")), category || "");
      // Reset form & render
      form.reset();
      nameInput.focus();
      renderAll();
      // also update stored project data if project active
      if (currentProjectName) {
        const projects = loadProjectsObj();
        projects[currentProjectName] = {
          data: tableData,
          commission: Number(currentCommission || 0)
        };
        saveProjectsObj(projects);
      }
    });
    // Row actions
    function editRow() {
      if (selectedIndex === null) {
        showAlert('Pilih baris dulu!');
        return;
      }
      const r = tableData[selectedIndex];
      nameInput.value = r.name;
      qtyInput.value = r.qty !== "" ? r.qty : "";
      unitInput.value = r.unit || "";
      priceInput.value = r.price !== "" ? Number(r.price).toLocaleString('id-ID') : "";
      marginInput.value = (r.margin !== undefined && r.margin !== null) ? r.margin : "";
      sellingInput.value = (r.sellingPrice != null && r.sellingPrice !== "") ? Number(r.sellingPrice).toLocaleString('id-ID') : "";
      categoryInput.value = r.category;
      switchTo('cogs');
      nameInput.focus();
    }

    function deleteRow() {
      if (selectedIndex === null) {
        showAlert('Pilih baris dulu!');
        return;
      }
      if (!confirm('Hapus baris ini?')) return;
      tableData.splice(selectedIndex, 1);
      selectedIndex = null;
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      renderAll();
      if (currentProjectName) {
        const projects = loadProjectsObj();
        projects[currentProjectName] = {
          data: tableData,
          commission: Number(currentCommission || 0)
        };
        saveProjectsObj(projects);
      }
    }
    // EXPORT & PDF (unchanged logic, omitted for brevity in comment)
    async function exportExcel() {
      if (!tableData.length) {
        showAlert('Tidak ada data untuk diekspor.');
        return;
      }
      const filename = getSafeFileName(currentProjectName) + ".xlsx";
      const workbook = new ExcelJS.Workbook();
      const sheet = workbook.addWorksheet("BOQ");
      if (activeTab === 'cogs') {
        sheet.columns = [{
          header: "No",
          key: "no",
          width: 6
        }, {
          header: "Nama Item",
          key: "name",
          width: 40
        }, {
          header: "Qty",
          key: "qty",
          width: 10
        }, {
          header: "Unit",
          key: "unit",
          width: 12
        }, {
          header: "Harga COGS",
          key: "price",
          width: 18
        }, {
          header: "Total COGS",
          key: "totalCogs",
          width: 18
        }, {
          header: "Margin (%)",
          key: "margin",
          width: 12
        }];
        sheet.getRow(1).eachCell((cell, colNum) => {
          cell.font = {
            name: 'Arial',
            bold: true,
            color: {
              argb: "FFFFFFFF"
            }
          };
          cell.fill = {
            type: "pattern",
            pattern: "solid",
            fgColor: {
              argb: "FF1F4E78"
            }
          };
          cell.alignment = {
            horizontal: "center",
            vertical: "middle",
            wrapText: colNum === 2 ? true : false
          };
          cell.border = {
            top: {
              style: "thin"
            },
            left: {
              style: "thin"
            },
            bottom: {
              style: "thin"
            },
            right: {
              style: "thin"
            }
          };
        });
        const grouped = {};
        tableData.forEach(r => {
          const cat = sanitize(r.category || "Uncategorized");
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(r);
        });
        let no = 1;
        for (const cat of Object.keys(grouped)) {
          const secRow = sheet.addRow([cat]);
          const lastCol = 7;
          sheet.mergeCells(`A${secRow.number}:${String.fromCharCode(64 + lastCol)}${secRow.number}`);
          for (let i = 1; i <= lastCol; i++) {
            const cell = secRow.getCell(i);
            cell.font = {
              name: 'Arial',
              bold: true
            };
            cell.fill = {
              type: "pattern",
              pattern: "solid",
              fgColor: {
                argb: "FFEEEEEE"
              }
            };
            cell.alignment = {
              horizontal: "left",
              vertical: "middle"
            };
            cell.border = {
              top: {
                style: "thin"
              },
              left: {
                style: "thin"
              },
              bottom: {
                style: "thin"
              },
              right: {
                style: "thin"
              }
            };
          }
          grouped[cat].forEach(r => {
            const totalCogs = (r.price != null && r.price !== "" && r.qty != null && r.qty !== "") ? Number(r.price) * Number(r.qty) : "";
            const rowObj = {
              no: no++,
              name: r.name,
              qty: r.qty,
              unit: r.unit,
              price: r.price,
              totalCogs: totalCogs,
              margin: r.margin
            };
            const dr = sheet.addRow(rowObj);
            dr.eachCell((cell, colNum) => {
              cell.font = {
                name: 'Arial'
              };
              cell.border = {
                top: {
                  style: "thin"
                },
                left: {
                  style: "thin"
                },
                bottom: {
                  style: "thin"
                },
                right: {
                  style: "thin"
                }
              };
              if (colNum >= 5) {
                cell.numFmt = "#,##0";
                cell.alignment = {
                  horizontal: "right",
                  vertical: "middle"
                };
              } else if (colNum === 2) {
                cell.alignment = {
                  horizontal: "left",
                  vertical: "middle",
                  wrapText: true
                };
              } else {
                cell.alignment = {
                  horizontal: "center",
                  vertical: "middle"
                };
              }
            });
          });
        }
        const sumCogs = tableData.reduce((a, b) => a + (Number(b.price || 0) * Number(b.qty || 0)), 0);
        const tr = sheet.addRow([]);
        const lastCol = 7;
        sheet.mergeCells(`A${tr.number}:F${tr.number}`);
        for (let i = 1; i <= lastCol; i++) {
          const cell = tr.getCell(i);
          cell.font = {
            name: 'Arial',
            bold: i === 1
          };
          cell.fill = {
            type: "pattern",
            pattern: "solid",
            fgColor: {
              argb: "FFFEF3D6"
            }
          };
          cell.alignment = {
            horizontal: i === 1 ? "center" : "right",
            vertical: "middle"
          };
          cell.border = {
            top: {
              style: "thin"
            },
            left: {
              style: "thin"
            },
            bottom: {
              style: "thin"
            },
            right: {
              style: "thin"
            }
          };
        }
        tr.getCell(1).value = "Grand Total COGS";
        tr.getCell(7).value = sumCogs;
        tr.getCell(7).numFmt = "#,##0";
        tr.getCell(7).font = {
          name: 'Arial',
          bold: true
        };
      } else {
        sheet.columns = [{
          header: "No",
          key: "no",
          width: 6
        }, {
          header: "Nama Item",
          key: "name",
          width: 40
        }, {
          header: "Qty",
          key: "qty",
          width: 10
        }, {
          header: "Unit",
          key: "unit",
          width: 12
        }, {
          header: "Harga Satuan",
          key: "sellingPrice",
          width: 18
        }, {
          header: "Total",
          key: "totalSelling",
          width: 18
        }];
        sheet.getRow(1).eachCell((cell, colNum) => {
          cell.font = {
            name: 'Arial',
            bold: true,
            color: {
              argb: "FFFFFFFF"
            }
          };
          cell.fill = {
            type: "pattern",
            pattern: "solid",
            fgColor: {
              argb: "FF1F4E78"
            }
          };
          cell.alignment = {
            horizontal: "center",
            vertical: "middle",
            wrapText: colNum === 2 ? true : false
          };
          cell.border = {
            top: {
              style: "thin"
            },
            left: {
              style: "thin"
            },
            bottom: {
              style: "thin"
            },
            right: {
              style: "thin"
            }
          };
        });
        const grouped = {};
        tableData.forEach(r => {
          const cat = sanitize(r.category || "Uncategorized");
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(r);
        });
        let no = 1;
        for (const cat of Object.keys(grouped)) {
          const secRow = sheet.addRow([cat]);
          const lastCol = 6;
          sheet.mergeCells(`A${secRow.number}:${String.fromCharCode(64 + lastCol)}${secRow.number}`);
          for (let i = 1; i <= lastCol; i++) {
            const cell = secRow.getCell(i);
            cell.font = {
              name: 'Arial',
              bold: true
            };
            cell.fill = {
              type: "pattern",
              pattern: "solid",
              fgColor: {
                argb: "FFEEEEEE"
              }
            };
            cell.alignment = {
              horizontal: "left",
              vertical: "middle"
            };
            cell.border = {
              top: {
                style: "thin"
              },
              left: {
                style: "thin"
              },
              bottom: {
                style: "thin"
              },
              right: {
                style: "thin"
              }
            };
          }
          grouped[cat].forEach(r => {
            let spRaw = null;
            if (r.sellingPrice != null && r.sellingPrice !== "") spRaw = Number(r.sellingPrice);
            else if (r.price != null && r.price !== "") spRaw = calcSellingPrice(Number(r.price), r.margin);
            const spRounded = spRaw != null ? roundUpToThousand(spRaw) : "";
            const totalSp = (spRounded !== "") ? Number(r.qty || 0) * spRounded : "";
            const rowObj = {
              no: no++,
              name: r.name,
              qty: r.qty,
              unit: r.unit,
              sellingPrice: spRounded,
              totalSelling: totalSp
            };
            const dr = sheet.addRow(rowObj);
            dr.eachCell((cell, colNum) => {
              cell.font = {
                name: 'Arial'
              };
              cell.border = {
                top: {
                  style: "thin"
                },
                left: {
                  style: "thin"
                },
                bottom: {
                  style: "thin"
                },
                right: {
                  style: "thin"
                }
              };
              if (colNum >= 5) {
                cell.numFmt = "#,##0";
                cell.alignment = {
                  horizontal: "right",
                  vertical: "middle"
                };
              } else if (colNum === 2) {
                cell.alignment = {
                  horizontal: "left",
                  vertical: "middle",
                  wrapText: true
                };
              } else {
                cell.alignment = {
                  horizontal: "center",
                  vertical: "middle"
                };
              }
            });
          });
        }
        const sumSelling = tableData.reduce((a, b) => {
          let sp = null;
          if (b.sellingPrice != null && b.sellingPrice !== "") sp = Number(b.sellingPrice);
          else if (b.price != null && b.price !== "") sp = calcSellingPrice(Number(b.price), b.margin);
          const spr = sp != null ? roundUpToThousand(sp) : 0;
          return a + (spr ? (Number(b.qty || 0) * spr) : 0);
        }, 0);
        const tr = sheet.addRow([]);
        sheet.mergeCells(`A${tr.number}:E${tr.number}`);
        for (let i = 1; i <= 6; i++) {
          const cell = tr.getCell(i);
          cell.font = {
            name: 'Arial',
            bold: i === 1
          };
          cell.fill = {
            type: "pattern",
            pattern: "solid",
            fgColor: {
              argb: "FFFEF3D6"
            }
          };
          cell.alignment = {
            horizontal: i === 1 ? "center" : "right",
            vertical: "middle"
          };
          cell.border = {
            top: {
              style: "thin"
            },
            left: {
              style: "thin"
            },
            bottom: {
              style: "thin"
            },
            right: {
              style: "thin"
            }
          };
        }
        tr.getCell(1).value = "Grand Total";
        tr.getCell(6).value = sumSelling;
        tr.getCell(6).numFmt = "#,##0";
        tr.getCell(6).font = {
          name: 'Arial',
          bold: true
        };
      }
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function exportPDF() {
      if (!tableData.length) {
        showAlert('Tidak ada data untuk diekspor.');
        return;
      }
      const {
        jsPDF
      } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      const title = currentProjectName ? `BOQ - ${currentProjectName}` : 'BOQ';
      doc.text(title, 14, 15);
      const grouped = {};
      tableData.forEach(r => {
        const cat = sanitize(r.category || 'Uncategorized');
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(r);
      });
      const body = [];
      let rowNoGlobal = 1;
      if (activeTab === 'cogs') {
        for (const cat of Object.keys(grouped)) {
          body.push([{
            content: cat,
            colSpan: 7,
            styles: {
              fillColor: [238, 238, 238],
              fontStyle: "bold",
              halign: "left",
              valign: "middle"
            }
          }]);
          grouped[cat].forEach(r => {
            const totalCogs = (r.price != null && r.price !== "" && r.qty != null && r.qty !== "") ? Number(r.price) * Number(r.qty) : "";
            body.push([rowNoGlobal++, r.name, r.qty, r.unit, {
              content: r.price != null && r.price !== "" ? Number(r.price).toLocaleString('id-ID') : "",
              styles: {
                halign: 'right',
                valign: 'middle'
              }
            }, {
              content: totalCogs !== "" ? Number(totalCogs).toLocaleString('id-ID') : "",
              styles: {
                halign: 'right',
                valign: 'middle'
              }
            }, {
              content: r.margin != null && r.margin !== "" ? Number(r.margin).toFixed(2) : "",
              styles: {
                halign: 'right',
                valign: 'middle'
              }
            }]);
          });
        }
        const grandCogs = tableData.reduce((a, b) => a + (Number(b.price || 0) * Number(b.qty || 0)), 0);
        body.push([{
          content: "Grand Total COGS",
          colSpan: 6,
          styles: {
            fontStyle: "bold",
            halign: "center",
            valign: "middle",
            fillColor: [254, 243, 214]
          }
        }, {
          content: grandCogs.toLocaleString('id-ID'),
          styles: {
            fontStyle: "bold",
            halign: "right",
            valign: "middle",
            fillColor: [254, 243, 214]
          }
        }]);
        const head = ["No", "Nama Item", "Qty", "Unit", "Harga COGS", "Total COGS", "Margin (%)"];
        doc.autoTable({
          head: [head],
          body,
          startY: 22,
          theme: 'grid',
          headStyles: {
            fillColor: [31, 78, 120],
            textColor: [255, 255, 255],
            halign: 'center',
            valign: 'middle'
          },
          columnStyles: {
            0: {
              halign: 'center',
              valign: 'middle'
            },
            2: {
              halign: 'center',
              valign: 'middle'
            }
          },
          styles: {
            fontSize: 10,
            cellPadding: 3
          }
        });
      } else {
        for (const cat of Object.keys(grouped)) {
          body.push([{
            content: cat,
            colSpan: 6,
            styles: {
              fillColor: [238, 238, 238],
              fontStyle: "bold",
              halign: "left",
              valign: "middle"
            }
          }]);
          grouped[cat].forEach(r => {
            let spRaw = null;
            if (r.sellingPrice != null && r.sellingPrice !== "") spRaw = Number(r.sellingPrice);
            else if (r.price != null && r.price !== "") spRaw = calcSellingPrice(Number(r.price), r.margin);
            const spRounded = spRaw != null ? roundUpToThousand(spRaw) : "";
            const totalSp = (spRounded !== "") ? Number(r.qty || 0) * spRounded : "";
            body.push([rowNoGlobal++, r.name, r.qty, r.unit, {
              content: spRounded !== "" ? Number(spRounded).toLocaleString('id-ID') : "",
              styles: {
                halign: 'right',
                valign: 'middle'
              }
            }, {
              content: totalSp !== "" ? Number(totalSp).toLocaleString('id-ID') : "",
              styles: {
                halign: 'right',
                valign: 'middle'
              }
            }]);
          });
        }
        const grandSelling = tableData.reduce((a, b) => {
          let sp = null;
          if (b.sellingPrice != null && b.sellingPrice !== "") sp = Number(b.sellingPrice);
          else if (b.price != null && b.price !== "") sp = calcSellingPrice(Number(b.price), b.margin);
          const spr = sp != null ? roundUpToThousand(sp) : 0;
          return a + (spr ? (Number(b.qty || 0) * spr) : 0);
        }, 0);
        body.push([{
          content: "Grand Total",
          colSpan: 5,
          styles: {
            fontStyle: "bold",
            halign: "center",
            valign: "middle",
            fillColor: [254, 243, 214]
          }
        }, {
          content: grandSelling.toLocaleString('id-ID'),
          styles: {
            fontStyle: "bold",
            halign: "right",
            valign: "middle",
            fillColor: [254, 243, 214]
          }
        }]);
        const head = ["No", "Nama Item", "Qty", "Unit", "Harga Satuan", "Total"];
        doc.autoTable({
          head: [head],
          body,
          startY: 22,
          theme: 'grid',
          headStyles: {
            fillColor: [31, 78, 120],
            textColor: [255, 255, 255],
            halign: 'center',
            valign: 'middle'
          },
          columnStyles: {
            0: {
              halign: 'center',
              valign: 'middle'
            },
            2: {
              halign: 'center',
              valign: 'middle'
            }
          },
          styles: {
            fontSize: 10,
            cellPadding: 3
          }
        });
      }
      const filename = getSafeFileName(currentProjectName) + ".pdf";
      doc.save(filename);
    }
    // MANAGE ITEMS & PROJECTS
    manageBtn.addEventListener('click', () => {
      populateManageItems();
      manageModal.style.display = 'block';
      manageModal.setAttribute('aria-hidden', 'false');
    });
    modalClose.addEventListener('click', () => {
      manageModal.style.display = 'none';
      manageModal.setAttribute('aria-hidden', 'true');
    });
    projectsClose.addEventListener('click', () => {
      projectsModal.style.display = 'none';
      projectsModal.setAttribute('aria-hidden', 'true');
    });
    manageProjectsBtn.addEventListener('click', () => {
      populateManageProjects();
      projectsModal.style.display = 'block';
      projectsModal.setAttribute('aria-hidden', 'false');
    });

    function populateManageItems() {
      manageItemList.innerHTML = '';
      // show items sorted by updatedAt desc
      const sorted = items.slice().sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      sorted.forEach((it, idx) => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        const small = document.createElement('div');
        small.style.fontSize = '12px';
        small.style.color = '#666';
        small.textContent = `Unit: ${it.unit||'-'} · COGS: ${it.price !== "" && it.price != null ? Number(it.price).toLocaleString('id-ID') : '-'} · Jual: ${it.sellingPrice !== "" && it.sellingPrice != null ? Number(it.sellingPrice).toLocaleString('id-ID') : '-'} · Kategori: ${it.category||'-'}`;
        span.textContent = it.name;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.className = 'btn secondary';
        delBtn.addEventListener('click', () => {
          if (!confirm(`Hapus item "${it.name}"?`)) return; // remove all matching names (case-insensitive)
          const key = normalizeKey(it.name);
          items = items.filter(x => normalizeKey(x.name) !== key);
          localStorage.setItem('boq_items', JSON.stringify(items));
          updateDatalist();
          populateManageItems();
        });
        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.className = 'btn ghost';
        renameBtn.addEventListener('click', () => {
          const newName = sanitize(prompt('Ubah nama item:', it.name) || '');
          if (!newName) return;
          // update all matching items with same normalized key
          const oldKey = normalizeKey(it.name);
          items.forEach(x => {
            if (normalizeKey(x.name) === oldKey) x.name = newName;
          });
          localStorage.setItem('boq_items', JSON.stringify(items));
          updateDatalist();
          populateManageItems();
        });
        const useBtn = document.createElement('button');
        useBtn.textContent = 'Gunakan';
        useBtn.className = 'btn';
        useBtn.style.marginLeft = '8px';
        useBtn.addEventListener('click', () => {
          // autofill form with this item (user convenience)
          nameInput.value = it.name;
          autofillFromItem(it.name);
          manageModal.style.display = 'none';
        });
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.flexDirection = 'column';
        wrapper.appendChild(span);
        wrapper.appendChild(small);
        li.appendChild(wrapper);
        li.appendChild(useBtn);
        li.appendChild(renameBtn);
        li.appendChild(delBtn);
        manageItemList.appendChild(li);
      });
    }

    function populateManageProjects() {
      manageProjectList.innerHTML = '';
      const projects = loadProjectsObj();
      Object.keys(projects).forEach(name => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = name;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Hapus';
        delBtn.className = 'btn secondary';
        delBtn.addEventListener('click', () => {
          if (!confirm(`Hapus project "${name}"?`)) return;
          delete projects[name];
          saveProjectsObj(projects);
          populateManageProjects();
          updateProjectList();
        });
        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.className = 'btn ghost';
        renameBtn.addEventListener('click', () => {
          const newName = sanitize(prompt('Ubah nama project:', name) || '');
          if (!newName) return;
          if (projects[newName]) {
            showAlert('Nama project sudah ada.');
            return;
          }
          projects[newName] = projects[name];
          delete projects[name];
          saveProjectsObj(projects);
          if (currentProjectName === name) {
            currentProjectName = newName;
            localStorage.setItem('boq_current_name', currentProjectName);
            updateNavProject();
          }
          populateManageProjects();
          updateProjectList();
        });
        li.appendChild(span);
        li.appendChild(renameBtn);
        li.appendChild(delBtn);
        manageProjectList.appendChild(li);
      });
    }
    window.addEventListener('click', (e) => {
      if (e.target === manageModal) {
        manageModal.style.display = 'none';
        manageModal.setAttribute('aria-hidden', 'true');
      }
      if (e.target === projectsModal) {
        projectsModal.style.display = 'none';
        projectsModal.setAttribute('aria-hidden', 'true');
      }
    });

    function updateProjectList() {
      const projects = loadProjectsObj();
      projectList.innerHTML = '';
      Object.keys(projects).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        projectList.appendChild(opt);
      });
    }

    function saveProject() {
      if (!tableData.length) {
        showAlert('Tidak ada data untuk disimpan.');
        return;
      }
      let name = prompt('Masukkan nama project:', currentProjectName || '');
      if (!name) return;
      name = sanitize(name);
      const projects = loadProjectsObj();
      if (projects[name] && !confirm('Nama project sudah ada. Timpa?')) return;
      projects[name] = {
        data: tableData,
        commission: Number(currentCommission || 0)
      };
      saveProjectsObj(projects);
      currentProjectName = name;
      localStorage.setItem('boq_current_name', currentProjectName);
      updateProjectList();
      updateNavProject();
      showAlert(`Project "${name}" berhasil disimpan.`);
    }

    function loadProject() {
      const name = sanitize(projectSearch.value || '');
      if (!name) {
        showAlert('Masukkan nama project terlebih dahulu.');
        return;
      }
      const projects = loadProjectsObj();
      if (!projects[name]) {
        showAlert('Project tidak ditemukan.');
        return;
      }
      const stored = projects[name];
      if (Array.isArray(stored)) {
        tableData = stored;
        currentCommission = 0;
      } else if (stored && typeof stored === 'object') {
        tableData = stored.data || [];
        currentCommission = Number(stored.commission || 0);
      } else {
        tableData = [];
        currentCommission = 0;
      }
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      currentProjectName = name;
      localStorage.setItem('boq_current_name', currentProjectName);
      selectedIndex = null;
      updateNavProject();
      updateProjectList();
      renderAll();
      showAlert(`Project "${name}" berhasil dimuat.`);
    }

    function newProject() {
      if (!confirm('Buat project baru? Semua data saat ini akan dihapus.')) return;
      tableData = [];
      selectedIndex = null;
      currentProjectName = '';
      currentCommission = 0;
      localStorage.setItem('boq_working', JSON.stringify(tableData));
      localStorage.removeItem('boq_current_name');
      updateNavProject();
      renderAll();
      showAlert('Project baru siap diisi.');
    }
    renameProjectBtn.addEventListener('click', () => {
      if (!currentProjectName) {
        showAlert('Tidak ada project aktif. Simpan project dulu agar bisa rename.');
        return;
      }
      const newName = sanitize(prompt('Ubah nama project:', currentProjectName) || '');
      if (!newName) return;
      const projects = loadProjectsObj();
      if (projects[newName] && newName !== currentProjectName && !confirm('Nama project sudah ada. Timpa?')) return;
      if (projects[currentProjectName]) delete projects[currentProjectName];
      projects[newName] = {
        data: tableData,
        commission: Number(currentCommission || 0)
      };
      saveProjectsObj(projects);
      currentProjectName = newName;
      localStorage.setItem('boq_current_name', currentProjectName);
      updateProjectList();
      updateNavProject();
      showAlert('Nama project diubah.');
    });
    // ===== NEW: Backup & Restore seluruh data =====
    downloadJSONBtn.addEventListener('click', () => {
      const projects = loadProjectsObj();
      const payload = {
        exportedAt: new Date().toISOString(),
        projects: projects,
        items: items || [],
        working: tableData || [],
        currentProjectName: currentProjectName || null,
        unsavedCommission: Number(currentCommission || 0)
      };
      const ts = new Date();
      const pad = n => String(n).padStart(2, '0');
      const filename = `boq_backup_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.json`;
      const blob = new Blob([JSON.stringify(payload, null, 2)], {
        type: 'application/json'
      });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    });
    restoreJSONBtn.addEventListener('click', () => {
      restoreInput.value = '';
      restoreInput.click();
    });
    restoreInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        let parsed = null;
        try {
          parsed = JSON.parse(String(e.target.result));
        } catch (err) {
          showAlert('File tidak valid: bukan JSON.');
          return;
        }
        let restoreObj = {
          projects: {},
          items: [],
          working: [],
          currentProjectName: '',
          unsavedCommission: 0
        };
        if (parsed && typeof parsed === 'object') {
          if (parsed.projects && typeof parsed.projects === 'object') {
            restoreObj.projects = parsed.projects || {};
            restoreObj.items = Array.isArray(parsed.items) ? parsed.items : (parsed.items || []);
            restoreObj.working = Array.isArray(parsed.working) ? parsed.working : (parsed.working || []);
            restoreObj.currentProjectName = parsed.currentProjectName || (parsed.project || '') || '';
            restoreObj.unsavedCommission = Number(parsed.unsavedCommission || parsed.commission || 0);
          } else if (parsed.project && parsed.data) {
            const projName = sanitize(parsed.project) || ('Imported Project ' + new Date().toISOString());
            restoreObj.projects = loadProjectsObj();
            restoreObj.projects[projName] = {
              data: Array.isArray(parsed.data) ? parsed.data : [],
              commission: Number(parsed.commission || 0)
            };
            restoreObj.items = items || [];
            restoreObj.working = restoreObj.projects[projName].data;
            restoreObj.currentProjectName = projName;
            restoreObj.unsavedCommission = Number(parsed.commission || 0);
          } else {
            if (Array.isArray(parsed)) {
              restoreObj.working = parsed;
              restoreObj.items = items || [];
              restoreObj.projects = loadProjectsObj();
              restoreObj.currentProjectName = '';
              restoreObj.unsavedCommission = 0;
            } else {
              restoreObj.projects = parsed.projects || parsed.projectList || {};
              restoreObj.items = parsed.items || parsed.boq_items || [];
              restoreObj.working = parsed.working || parsed.boq_working || [];
              restoreObj.currentProjectName = parsed.currentProjectName || parsed.current || '';
              restoreObj.unsavedCommission = Number(parsed.unsavedCommission || parsed.commission || 0);
            }
          }
        }
        if (!confirm('Restore akan menimpa semua data lokal (projects, items, working, current project). Lanjutkan?')) {
          return;
        }
        try {
          saveProjectsObj(restoreObj.projects || {});
          localStorage.setItem('boq_items', JSON.stringify(restoreObj.items || []));
          localStorage.setItem('boq_working', JSON.stringify(restoreObj.working || []));
          if (restoreObj.currentProjectName) {
            localStorage.setItem('boq_current_name', restoreObj.currentProjectName);
            currentProjectName = restoreObj.currentProjectName;
          } else {
            localStorage.removeItem('boq_current_name');
            currentProjectName = '';
          }
          if (restoreObj.unsavedCommission && Number(restoreObj.unsavedCommission) !== 0) localStorage.setItem(UNSAVED_COMM_KEY, String(Number(restoreObj.unsavedCommission)));
          else localStorage.removeItem(UNSAVED_COMM_KEY);
          items = JSON.parse(localStorage.getItem('boq_items')) || [];
          tableData = JSON.parse(localStorage.getItem('boq_working')) || [];
          loadCommissionForCurrentProject();
          updateNavProject();
          updateProjectList();
          updateDatalist();
          renderAll();
          showAlert('Restore berhasil. Data lokal telah diperbarui.');
        } catch (err) {
          console.error(err);
          showAlert('Terjadi kesalahan saat menyimpan data ke localStorage.');
        }
      };
      reader.readAsText(f);
    });
    // INIT
    updateNavProject();
    updateProjectList();
    updateDatalist();
    loadCommissionForCurrentProject();
    renderAll();
    switchTo('cogs');
  </script>
</body>

</html>